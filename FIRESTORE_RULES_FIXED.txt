rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection: only the authenticated user may create/read/update/delete their own document
    match /users/{userId} {
      allow create: if request.auth != null
        && request.auth.uid == userId
        // required keys the client is expected to supply
        && request.resource.data.keys().hasAll(['first_name', 'last_name', 'email', 'username', 'user_id'])
        && request.resource.data.first_name is string
        && request.resource.data.last_name is string
        && request.resource.data.email is string
        && request.resource.data.username is string
        && request.resource.data.user_id is string
        // ensure user_id matches doc id and email matches the authenticated user's email
        && request.resource.data.user_id == userId
        && request.resource.data.email == request.auth.token.email;

      allow read: if request.auth != null && request.auth.uid == userId;

      allow update, delete: if request.auth != null
        && request.auth.uid == userId
        // Prevent changing ownership/identity fields
        && request.resource.data.user_id == resource.data.user_id
        && request.resource.data.email == resource.data.email;
    }

    // Listings collection: allow anyone to read, authenticated users can create/update/delete their own
    match /tbl_listing/{listingId} {
      // Allow anyone to read listings
      allow read: if true;
      
      // Allow anyone to create listings (for unauthenticated users from web app)
      // FIXED: Use hasAll() on required fields and allow extra fields to be sent
      allow create: if request.resource.data.keys().hasAll(['title', 'description', 'price', 'category', 'user_id'])
        && request.resource.data.title is string
        && request.resource.data.description is string
        && request.resource.data.price is number
        && request.resource.data.category is string
        && request.resource.data.user_id is string;
      
      // Allow users to update/delete their own listings
      // Allow unauthenticated users to update/delete their own listings by matching user_id
      allow update, delete: if resource.data.user_id == request.resource.data.user_id;
    }

    // Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
