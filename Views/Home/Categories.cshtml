@{
    ViewData["Title"] = "Categories - Browse by Collection";
    var counts = ViewBag.CategoryCounts as System.Collections.Generic.Dictionary<string, int> ?? new System.Collections.Generic.Dictionary<string, int>();
    int CountFor(string key) => counts.TryGetValue(key, out var v) ? v : 0;

    var userType = Context.Session.GetString("UserType") ?? "buyer";
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/categories.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/pages/mylistings.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/listing-form.css" asp-append-version="true" />
}



<!-- Categories Page -->
<section class="categories-page" data-user-type="@userType">
    <div class="container py-5">
        <!-- Page Header -->
    <div class="text-center mb-5">
            <h1 class="page-title mb-3">Browse Categories</h1>
    <p class="page-subtitle text-muted">Find exactly what you're looking for</p>
        </div>

        @if (userType == "admin")
        {
            <button class="btn-add-new" id="addNewListingBtn" onclick="openCategoryModal()" style="margin: 12px 0;">
                <i class="bi bi-plus-circle me-2"></i>
                Add New Category
            </button>
        }

        <!-- Categories Grid -->
        <div class="row g-4 justify-content-center">
            <!-- Electronics -->
            <div class="col-12 col-sm-6 col-lg-3">
                <a href="@Url.Action("Browse", "Home", new { category = "Electronics" })" class="category-card" data-category="Electronics">
                    <div class="category-icon-wrapper">
                        <i class="bi bi-laptop category-icon"></i>
                    </div>
                    <h3 class="category-name">Electronics</h3>
                    <p class="category-count">@CountFor("Electronics") items</p>
                </a>
            </div>

            <!-- Fashion -->
            <div class="col-12 col-sm-6 col-lg-3">
                <a href="@Url.Action("Browse", "Home", new { category = "Fashion" })" class="category-card" data-category="Fashion">
                    <div class="category-icon-wrapper">
                        <i class="bi bi-bag category-icon"></i>
                    </div>
                    <h3 class="category-name">Fashion</h3>
                    <p class="category-count">@CountFor("Fashion") items</p>
                </a>
            </div>

            <!-- Home & Living -->
            <div class="col-12 col-sm-6 col-lg-3">
                <a href="@Url.Action("Browse", "Home", new { category = "Home & Living" })" class="category-card" data-category="Home & Living">
                    <div class="category-icon-wrapper">
                        <i class="bi bi-house-door category-icon"></i>
                    </div>
                    <h3 class="category-name">Home &amp; Living</h3>
                    <p class="category-count">@CountFor("Home & Living") items</p>
                </a>
            </div>

            <!-- Books -->
            <div class="col-12 col-sm-6 col-lg-3">
                <a href="@Url.Action("Browse", "Home", new { category = "Books" })" class="category-card" data-category="Books">
                    <div class="category-icon-wrapper">
                        <i class="bi bi-book category-icon"></i>
                    </div>
                    <h3 class="category-name">Books</h3>
                    <p class="category-count">@CountFor("Books") items</p>
                </a>
            </div>

            <!-- Sports -->
            <div class="col-12 col-sm-6 col-lg-3">
                <a href="@Url.Action("Browse", "Home", new { category = "Sports" })" class="category-card" data-category="Sports">
                    <div class="category-icon-wrapper">
                        <i class="bi bi-trophy category-icon"></i>
                    </div>
                    <h3 class="category-name">Sports</h3>
                    <p class="category-count">@CountFor("Sports") items</p>
                </a>
            </div>

            <!-- Toys & Games -->
            <div class="col-12 col-sm-6 col-lg-3">
                <a href="@Url.Action("Browse", "Home", new { category = "Toys & Games" })" class="category-card" data-category="Toys & Games">
                    <div class="category-icon-wrapper">
                        <i class="bi bi-controller category-icon"></i>
                    </div>
                    <h3 class="category-name">Toys &amp; Games</h3>
                    <p class="category-count">@CountFor("Toys & Games") items</p>
                </a>
            </div>

            <!-- Vehicles -->
            <div class="col-12 col-sm-6 col-lg-3">
                <a href="@Url.Action("Browse", "Home", new { category = "Vehicles" })" class="category-card" data-category="Vehicles">
                    <div class="category-icon-wrapper">
                        <i class="bi bi-truck category-icon"></i>
                    </div>
                    <h3 class="category-name">Vehicles</h3>
                    <p class="category-count">@CountFor("Vehicles") items</p>
                </a>
            </div>

            <!-- Beauty -->
            <div class="col-12 col-sm-6 col-lg-3">
                <a href="@Url.Action("Browse", "Home", new { category = "Beauty" })" class="category-card" data-category="Beauty">
                    <div class="category-icon-wrapper">
                        <i class="bi bi-stars category-icon"></i>
                    </div>
                    <h3 class="category-name">Beauty</h3>
                    <p class="category-count">@CountFor("Beauty") items</p>
                </a>
            </div>
        </div>
    </div>
</section>

<!-- Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="categoryForm">
                <div class="modal-header">
                    <h5 class="modal-title">Add Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="Name" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="category_name" name="Name" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Create</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>


@section Scripts {
    <script src="~/js/firebase-client.js" type="module"></script>
    <script>
        
        
        
        // Populate counts using client-side Firestore if server counts are zero
        (function waitForFirebase(){
            if (typeof window.firebaseFetchProductsByCategory !== 'function') {
                setTimeout(waitForFirebase, 150);
                return;
            }

            async function refreshCounts() {
                const cards = document.querySelectorAll('.category-card');
                for (const card of cards) {
                    const cat = card.getAttribute('data-category');
                    const el = card.querySelector('.category-count');
                    if (!cat || !el) continue;
                    try {
                        const res = await window.firebaseFetchProductsByCategory(cat);
                        if (res && res.success) {
                            el.textContent = `${res.count} items`;
                        } else {
                            // fallback to existing server rendered number if available
                            // do nothing
                        }
                    } catch (e) {
                        console.debug('Failed fetch count for', cat, e?.message || e);
                    }
                }
            }

            refreshCounts();
        
        })();
    </script>
}
