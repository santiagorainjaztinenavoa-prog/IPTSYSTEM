<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generate PH Address JSON Files</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; }
    #log { max-height: 50vh; overflow:auto; font-size:12px; }
    .spinner { width:16px; height:16px; border:3px solid #ccc; border-top-color:#0d6efd; border-radius:50%; animation: spin 0.8s linear infinite; display:inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h1 class="h4 mb-3">Generate Static PH Address JSON Files</h1>
    <p class="text-muted">This tool fetches Philippine address data from PSGC API and generates JSON files for local use (zero Firestore reads).</p>

    <div class="mb-3">
      <button id="generateBtn" class="btn btn-primary">Generate All JSON Files</button>
      <button id="downloadAllBtn" class="btn btn-success" disabled>Download ph-addresses.json</button>
      <span id="status" class="ms-3"></span>
    </div>
    
    <div class="mb-2">
      <small id="progress" class="text-muted"></small>
    </div>
    
    <pre id="log" class="bg-light border p-3"></pre>
    
    <div id="output" class="mt-3" style="display:none;">
      <h5>Generated Data Preview</h5>
      <p class="text-muted small">Copy the content below or use the download button.</p>
      <textarea id="jsonOutput" class="form-control" rows="10" readonly></textarea>
    </div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const progressEl = document.getElementById('progress');
    const generateBtn = document.getElementById('generateBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const outputDiv = document.getElementById('output');
    const jsonOutputEl = document.getElementById('jsonOutput');
    
    let generatedData = null;

    function log(...args) {
      const line = args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ');
      logEl.textContent += line + '\n';
      logEl.scrollTop = logEl.scrollHeight;
      console.log(...args);
    }
    
    function setStatus(text, spinner=false) {
      statusEl.innerHTML = spinner ? `<span class="spinner"></span> ${text}` : text;
    }

    async function fetchJson(url, label) {
      log(`Fetching ${label}...`);
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`${label} fetch failed: ${resp.status}`);
      const data = await resp.json();
      log(`‚úÖ ${label} fetched: ${data.length} records`);
      return data;
    }

    generateBtn.addEventListener('click', async () => {
      generateBtn.disabled = true;
      setStatus('Fetching data from PSGC API...', true);
      logEl.textContent = '';
      
      try {
        // Fetch all data from PSGC API
        log('Starting data fetch from https://psgc.gitlab.io/api/');
        log('This may take a minute for barangays...');
        log('');
        
        const [regionsRaw, provincesRaw, citiesRaw, barangaysRaw] = await Promise.all([
          fetchJson('https://psgc.gitlab.io/api/regions/', 'Regions'),
          fetchJson('https://psgc.gitlab.io/api/provinces/', 'Provinces'),
          fetchJson('https://psgc.gitlab.io/api/cities-municipalities/', 'Cities/Municipalities'),
          fetchJson('https://psgc.gitlab.io/api/barangays/', 'Barangays')
        ]);
        
        log('');
        log('Processing and formatting data...');
        
        // Format regions
        const regions = regionsRaw.map(r => ({
          code: r.code,
          name: r.regionName || r.name
        })).sort((a, b) => a.name.localeCompare(b.name));
        
        // Format provinces with regionCode
        const provinces = provincesRaw.map(p => ({
          code: p.code,
          name: p.name,
          regionCode: p.regionCode
        })).sort((a, b) => a.name.localeCompare(b.name));
        
        // Format cities with regionCode and provinceCode
        const cities = citiesRaw.map(c => ({
          code: c.code,
          name: c.name,
          regionCode: c.regionCode,
          provinceCode: c.provinceCode
        })).sort((a, b) => a.name.localeCompare(b.name));
        
        // Format barangays with cityCode
        const barangays = barangaysRaw.map(b => ({
          code: b.code,
          name: b.name,
          cityCode: b.cityCode || b.municipalityCode
        })).sort((a, b) => a.name.localeCompare(b.name));
        
        generatedData = {
          regions,
          provinces,
          cities,
          barangays
        };
        
        log('');
        log('=== Summary ===');
        log(`Regions: ${regions.length}`);
        log(`Provinces: ${provinces.length}`);
        log(`Cities/Municipalities: ${cities.length}`);
        log(`Barangays: ${barangays.length}`);
        log('');
        log('‚úÖ Data ready! Click "Download ph-addresses.json" to save.');
        
        // Show preview
        const jsonStr = JSON.stringify(generatedData, null, 2);
        jsonOutputEl.value = jsonStr.substring(0, 5000) + '\n\n... (truncated for preview, full data in download)';
        outputDiv.style.display = 'block';
        
        downloadAllBtn.disabled = false;
        setStatus('‚úÖ Ready to download');
        
      } catch (err) {
        log('‚ùå Error:', err.message);
        setStatus('Failed');
      } finally {
        generateBtn.disabled = false;
      }
    });
    
    downloadAllBtn.addEventListener('click', () => {
      if (!generatedData) return;
      
      const jsonStr = JSON.stringify(generatedData, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ph-addresses.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      log('üìÅ Downloaded ph-addresses.json');
      log('');
      log('=== NEXT STEPS ===');
      log('1. Move the downloaded file to: wwwroot/data/ph-addresses.json');
      log('2. The updated firebase-client.js will automatically use this local file');
      log('3. Firestore reads for addresses will be ZERO!');
    });
  </script>
</body>
</html>
