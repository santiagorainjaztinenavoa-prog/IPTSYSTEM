<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seed PH Addresses to Firestore</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
</head>
<body class="p-4">
  <div class="container">
    <h1 class="h4 mb-3">Seed Firestore: PH Regions / Provinces / Cities / Barangays</h1>
    <p class="text-muted">Before seeding, temporarily allow reads/writes in Firestore rules for these collections or sign in with an authorized user.</p>

    <div class="mb-3">
      <button id="seedBtn" class="btn btn-primary">Seed Firestore</button>
      <span id="status" class="ms-2"></span>
    </div>

    <pre id="log" class="bg-light border p-3" style="max-height: 60vh; overflow:auto"></pre>
  </div>

  <script type="module">
    import app from '/js/firebase-client.js';
    import { getFirestore, collection, doc, setDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    const db = getFirestore(app);
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const seedBtn = document.getElementById('seedBtn');

    function log(...args) {
      const line = args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ');
      logEl.textContent += line + '\n';
      logEl.scrollTop = logEl.scrollHeight;
      console.log(...args);
    }

    async function fetchJson(url) {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Fetch failed ${url}: ${resp.status}`);
      return await resp.json();
    }

    async function batchSet(colName, items) {
      const chunk = 400;
      let total = 0;
      for (let i = 0; i < items.length; i += chunk) {
        const batch = writeBatch(db);
        const slice = items.slice(i, i + chunk);
        slice.forEach(it => {
          const ref = doc(collection(db, colName), String(it.id));
          batch.set(ref, it.data, { merge: true });
        });
        await batch.commit();
        total += slice.length;
        log(`Committed ${slice.length} to ${colName} (total: ${total})`);
      }
      return total;
    }

    async function seed() {
      try {
        statusEl.textContent = 'Seeding...';
        seedBtn.disabled = true;
        log('Downloading PSGC datasets...');
        const [regions, provinces, cities, barangays] = await Promise.all([
          fetchJson('https://psgc.gitlab.io/api/regions/'),
          fetchJson('https://psgc.gitlab.io/api/provinces/'),
          fetchJson('https://psgc.gitlab.io/api/cities-municipalities/'),
          fetchJson('https://psgc.gitlab.io/api/barangays/'),
        ]);

        log('Seeding regions...');
        await batchSet('ph_regions', regions.map(r => ({ id: r.code, data: { code: r.code, name: r.regionName } })));

        log('Seeding provinces...');
        await batchSet('ph_provinces', provinces.map(p => ({ id: p.code, data: { code: p.code, name: p.name, regionCode: p.regionCode } })));

        log('Seeding cities/municipalities...');
        await batchSet('ph_cities', cities.map(c => ({ id: c.code, data: { code: c.code, name: c.name, regionCode: c.regionCode, provinceCode: c.provinceCode } })));

        log('Seeding barangays (this may take several minutes)...');
        await batchSet('ph_barangays', barangays.map(b => ({ id: b.code, data: { code: b.code, name: b.name, cityCode: b.cityCode || b.municipalityCode } })));

        statusEl.textContent = 'Done';
        log('All done. Restore secure Firestore rules.');
      } catch (e) {
        statusEl.textContent = 'Failed';
        log('Error:', e.message || String(e));
      } finally {
        seedBtn.disabled = false;
      }
    }

    seedBtn.addEventListener('click', seed);
  </script>
</body>
</html>
