@model IPTSYSTEM.Models.Listing
@{
    ViewData["Title"] = "Seller Profile";
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/seller-profile.css" asp-append-version="true" />
    <style>
        .review-form-card { background:#fff;border:1px solid #eee;border-radius:12px;padding:16px; }
        .review-media-upload { display:flex; flex-direction:column; gap:12px; }
        .review-gallery { display:flex; flex-wrap:wrap; gap:8px; }
        .review-thumb { width:96px; height:96px; border-radius:8px; background:#f3f4f6; overflow:hidden; display:flex; align-items:center; justify-content:center; position:relative; }
        .review-thumb img { max-width:100%; max-height:100%; object-fit:cover; }
        .remove-thumb { position:absolute; top:4px; right:4px; border:none; background:rgba(0,0,0,.5); color:#fff; border-radius:50%; width:22px; height:22px; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer; }
        .video-preview { max-width:320px; border-radius:8px; background:#f3f4f6; }
        .minimal-input { border-radius:8px; }
        .star-rating i.star { cursor:pointer; }
        /* Lightbox for review media */
        .review-lightbox-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.8); display:none; align-items:center; justify-content:center; z-index: 1056; }
        .review-lightbox { max-width: 90vw; max-height: 85vh; border-radius: 12px; overflow:hidden; box-shadow: 0 20px 60px rgba(0,0,0,.4); background:#000; position:relative; }
        .review-lightbox img, .review-lightbox video { max-width: 90vw; max-height: 85vh; display:block; }
        .lightbox-close { position:absolute; top:8px; right:8px; background: rgba(255,255,255,.15); border:none; color:#fff; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; }
        .lightbox-close:hover { background: rgba(255,255,255,.3); }
    </style>
}

<!-- Seller Profile Page -->
<section class="seller-profile-page">
    <div class="container">
        <!-- Seller Header -->
        <div class="seller-header">
            <div class="seller-card-large">
                <div class="seller-avatar-large">
                    <span class="avatar-initial-large" id="sellerInitial">U</span>
                </div>
                <div class="seller-info-large">
                <h1 id="sellerName" class="seller-name-large">Seller Name</h1>
                <p id="sellerUsernameDisplay" class="seller-username-large"></p>
                <a href="#" id="sellerProfileDetailsLink" class="profile-username-link">Profile details <i class="bi bi-chevron-right"></i></a>
                    <div class="seller-stats">
                        <div class="stat">
                            <span class="stat-value" id="productCount">0</span>
                            <span class="stat-label">Products</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="ratingValue">4.5</span>
                            <span class="stat-label">Rating</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn-message-seller" id="messageBtn">
                        <i class="bi bi-chat-dots"></i>
                        Message
                    </button>
                    <!-- Follow button removed -->
                </div>
            </div>
        </div>

        <!-- Profile Tabs Section -->
        <div class="profile-tabs-section">
            <div class="d-flex justify-content-between align-items-center" style="padding: 0 40px;">
                <div class="profile-tabs">
                    <button class="profile-tab active" data-tab="listings" onclick="switchSellerTab('listings')">Listings</button>
                    <button class="profile-tab" data-tab="reviews" onclick="switchSellerTab('reviews')">Reviews</button>
                </div>
                <div class="view-controls" id="listingsControls">
                    <select id="sortSelect" class="sort-select" onchange="changeSortOrder()">
                        <option value="newest">Newest</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tab Contents -->
        <div class="profile-content-section">
            <!-- Listings Tab -->
            <div class="tab-content active" id="listingsContent">
                <div class="seller-products-grid" id="sellerProductsGrid">
                    <div class="loading-spinner">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading products...</p>
                    </div>
                </div>
            </div>

            <!-- Reviews Tab -->
            <div class="tab-content" id="reviewsContent">
                <!-- Add Review Form (Buyers and Sellers can review) -->
                <div class="add-review-section" id="addReviewSection" style="display: none;">
                    <h3 class="mb-3">Write a Review</h3>
                    <div class="review-form-card">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Rating *</label>
                            <div class="star-rating">
                                <i class="bi bi-star-fill star" data-rating="1"></i>
                                <i class="bi bi-star-fill star" data-rating="2"></i>
                                <i class="bi bi-star-fill star" data-rating="3"></i>
                                <i class="bi bi-star-fill star" data-rating="4"></i>
                                <i class="bi bi-star-fill star" data-rating="5"></i>
                            </div>
                            <input type="hidden" id="reviewRating" value="0">
                        </div>
                        <div class="mb-3">
                            <label for="reviewComment" class="form-label fw-bold">Message *</label>
                            <textarea class="form-control minimal-input" id="reviewComment" rows="4" placeholder="Share your experience with this seller..." required></textarea>
                            <small class="text-muted">Message is required to submit the review.</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Attach pictures (optional)</label>
                            <div class="review-media-upload">
                                <input type="file" id="reviewImageFiles" accept="image/*" class="form-control form-control-sm" multiple />
                                <div class="review-gallery" id="reviewImageGallery"></div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearReviewImages()">Remove All Images</button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Attach a video (optional)</label>
                            <input type="file" id="reviewVideoFile" accept="video/*" class="form-control form-control-sm" />
                            <video id="reviewVideoPreview" class="video-preview mt-2" controls style="display:none"></video>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="clearReviewVideo()">Remove Video</button>
                        </div>
                        <button class="btn btn-primary" onclick="submitReview()">
                            <i class="bi bi-send me-2"></i>Submit Review
                        </button>
                    </div>
                </div>

                <!-- Reviews List -->
                <div class="reviews-list-section">
                    <h3 class="mb-3">Customer Reviews</h3>
                    <div id="reviewsList">
                        <div class="loading-state">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading reviews...</span>
                            </div>
                            <p>Loading reviews...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- About Modal -->
<div class="modal fade" id="aboutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aboutTitle">About</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h6 class="mb-3">Account details</h6>
        <ul class="list-unstyled d-flex flex-column gap-2">
            <li class="d-flex align-items-center gap-2"><i class="bi bi-calendar"></i> <span id="joinedText">Joined �</span></li>
            <!-- Followers/Following removed -->
            <li class="d-flex align-items-center gap-2"><i class="bi bi-geo-alt"></i> <span id="locationText">�</span></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Lightbox for review media -->
<div id="sellerReviewLightboxBackdrop" class="review-lightbox-backdrop">
    <div class="review-lightbox" id="sellerReviewLightbox">
        <button class="lightbox-close" id="sellerLightboxCloseBtn" aria-label="Close"><i class="bi bi-x-lg"></i></button>
        <!-- content injected dynamically -->
    </div>
</div>

@section Scripts {
    <script src="~/js/firebase-client.js" type="module"></script>
    <script src="~/js/seller-products.js"></script>
    <script>
        // Get seller data from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const sellerId = urlParams.get('id');
        const sellerName = urlParams.get('name');
        let sellerUsername = urlParams.get('username');
        let sellerLocation = urlParams.get('location');

        const atSign = String.fromCharCode(64);

        // Review image state
        let reviewImageDataUrls = [];
        let reviewVideoDataUrl = '';

        // Initialize seller profile
        async function initializeSellerProfile() {
            if (!sellerId) {
                document.getElementById('sellerProductsGrid').innerHTML = '<p class="error">No seller selected</p>'; return;
            }
            try {
                // If username or location not provided, fetch from user profile
                await ensureSellerProfileData();

                // Display seller info (always prefer username over id)
                document.getElementById('sellerName').textContent = sellerName || 'Seller';
                const usernameDisplay = (sellerUsername || '').trim() ? sellerUsername : sellerId;
                document.getElementById('sellerUsernameDisplay').textContent = atSign + usernameDisplay;
                const initial = sellerName ? sellerName.charAt(0).toUpperCase() : (usernameDisplay ? usernameDisplay.charAt(0).toUpperCase() : 'U');
                document.getElementById('sellerInitial').textContent = initial;
                document.getElementById('aboutTitle').textContent = 'About ' + atSign + usernameDisplay;

                // Fetch seller products
                const products = await window.sellerProductsManager.fetchSellerProducts(sellerId);
                document.getElementById('productCount').textContent = products.length;

                // Joined text based on earliest product date as a proxy
                let joinedText = 'Joined recently';
                if (products && products.length > 0) {
                    const dates = products.map(p => {
                        const d = p.date_created || p.created_at || p.CreatedDate;
                        if (!d) return null;
                        if (d && d.seconds) return new Date(d.seconds * 1000);
                        return new Date(d);
                    }).filter(Boolean);
                    if (dates.length) {
                        const earliest = new Date(Math.min.apply(null, dates));
                        joinedText = formatRelativeJoin(earliest);
                    }
                }
                document.getElementById('joinedText').textContent = joinedText;
                document.getElementById('locationText').textContent = sellerLocation || 'Unknown City';

                if (products.length === 0) {
                    document.getElementById('sellerProductsGrid').innerHTML = '<p class="no-products">This seller has no products yet</p>'; return;
                }
                displaySellerProducts(products);
            } catch (error) {
                console.error('Error initializing seller profile:', error);
                document.getElementById('sellerProductsGrid').innerHTML = '<p class="error">Error loading seller products</p>';
            }
        }

        async function ensureSellerProfileData(){
            try{
                // Wait for Firebase client
                let retries = 0;
                while (typeof window.firebaseGetUserProfile !== 'function' && retries < 30) {
                    await new Promise(r => setTimeout(r, 100));
                    retries++;
                }
                if (typeof window.firebaseGetUserProfile === 'function'){
                    const res = await window.firebaseGetUserProfile(sellerId);
                    if (res?.success && res.profile){
                        // Prefer username and address/city from profile
                        if (!sellerUsername || sellerUsername.trim() === ''){
                            sellerUsername = res.profile.username || res.profile.user_name || sellerUsername;
                        }
                        const address = res.profile.address || res.profile.location || res.profile.city;
                        if (!sellerLocation || sellerLocation.trim() === ''){
                            sellerLocation = address || sellerLocation;
                        }
                    }
                }
            }catch(e){
                console.warn('ensureSellerProfileData failed', e);
            }
        }

        function formatRelativeJoin(date) {
            const now = new Date(); const diffMs = now - date; const minutes = Math.floor(diffMs / 60000); const days = Math.floor(minutes / (60 * 24)); const months = Math.floor(days / 30); const remDays = days - months * 30; return 'Joined ' + months + 'm ' + remDays + 'd';
        }

        function displaySellerProducts(products) {
            const grid = document.getElementById('sellerProductsGrid'); grid.innerHTML = '';
            products.forEach(product => { const card = createProductCard(product); grid.appendChild(card); });
        }

        function createProductCard(product) {
            const conditionClass = ((product.condition || 'new') + '').toLowerCase().replace(' ', '-');
            const imageSrc = product.imageUrl || product.image_url || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop';
            const title = product.title || 'Untitled'; const category = product.category || 'Uncategorized'; const priceText = window.formatCurrency(product.price || 0); const productId = product.id || product.product_id;
            const html = '<div class="product-image-container">' +
                '<img src="' + imageSrc + '" alt="' + title + '" class="product-image" onerror="this.src=\'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop\'">' +
                '<span class="condition-badge badge-' + conditionClass + '">' + (product.condition || 'New') + '</span>' +
                '</div>' +
                '<div class="product-info">' +
                '<h3 class="product-title">' + title + '</h3>' +
                '<p class="product-category">' + category + '</p>' +
                '<p class="product-price">' + priceText + '</p>' +
                '</div>' +
                '<button class="btn-view-product" onclick="viewProduct(\'' + productId + '\')">View</button>';
            const card = document.createElement('div'); card.className = 'seller-product-card'; card.innerHTML = html; return card;
        }

        function changeSortOrder() {
            const sortSelect = document.getElementById('sortSelect'); const order = sortSelect.value; const products = window.sellerProductsManager.getSellerProducts();
            let sorted; if (order === 'newest') { sorted = window.sellerProductsManager.sortByDate(products, 'newest'); } else if (order === 'price-low') { sorted = window.sellerProductsManager.sortByPrice(products, 'asc'); } else if (order === 'price-high') { sorted = window.sellerProductsManager.sortByPrice(products, 'desc'); }
            displaySellerProducts(sorted);
        }

        function viewProduct(productId) { window.location.href = '/Home/Browse?productId=' + productId; }
        document.getElementById('messageBtn').addEventListener('click', messageSellerFromProfile);
        document.getElementById('sellerProfileDetailsLink').addEventListener('click', (e) => { e.preventDefault(); const modal = new bootstrap.Modal(document.getElementById('aboutModal')); modal.show(); });
        
        // Message seller from profile
        async function messageSellerFromProfile() {
            const currentUserId = '@(Context.Session.GetString("UserId") ?? "")'; const currentUserName = '@(Context.Session.GetString("FullName") ?? Context.Session.GetString("Username") ?? "")';
            if (!currentUserId) { alert('Please login to message this seller'); window.location.href = '/Home/Login'; return; }
            if (currentUserId === sellerId) { alert('You cannot message yourself'); return; }
            if (typeof window.firebaseStartConversation === 'function') {
                try {
                    const result = await window.firebaseStartConversation(currentUserId, currentUserName, sellerId, sellerName, sellerUsername || '', 'General Inquiry');
                    if (result.success && result.conversation) { window.location.href = '/Home/Messages?conversationId=' + result.conversation.id; } else { alert('Failed to start conversation: ' + (result.message || 'Unknown error')); }
                } catch (error) { console.error('Error starting conversation:', error); alert('Error starting conversation. Please try again.'); }
            } else { alert('Messaging feature not available. Please refresh the page.'); }
        }

        // Tab switching functionality
        function switchSellerTab(tabName) {
            document.querySelectorAll('.profile-tab').forEach(tab => { tab.classList.remove('active'); });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => { content.classList.remove('active'); });
            document.getElementById(tabName + 'Content').classList.add('active');
            const sortControls = document.getElementById('listingsControls'); if (sortControls) { sortControls.style.display = tabName === 'listings' ? 'flex' : 'none'; }
            if (tabName === 'reviews') { loadReviews(); }
        }
        window.switchSellerTab = switchSellerTab;

        // ========== REVIEWS FUNCTIONALITY ==========
        let currentUserId = '@(Context.Session.GetString("UserId") ?? "")';
        let currentUserType = '@(Context.Session.GetString("UserType") ?? "")';
        let currentUserName = '@(Context.Session.GetString("FullName") ?? "")';
        let currentUserUsername = '@(Context.Session.GetString("Username") ?? "")';
        let selectedRating = 0;
        
        // Show add review form for buyers AND sellers (must be logged in)
        async function checkUserTypeAndShowReviewForm() {
            const addReviewSection = document.getElementById('addReviewSection');
            if (currentUserId) {
                // allow both buyers and sellers to review sellers
                addReviewSection.style.display = 'block';
                setupStarRating();
                setupReviewImageInputs();
            } else {
                addReviewSection.style.display = 'none';
            }
        }
        
        function setupStarRating() {
            const stars = document.querySelectorAll('.star-rating .star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.getAttribute('data-rating'));
                    document.getElementById('reviewRating').value = selectedRating;
                    updateStarDisplay(selectedRating);
                });
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    updateStarDisplay(rating);
                });
            });
            document.querySelector('.star-rating').addEventListener('mouseleave', function() { updateStarDisplay(selectedRating); });
        }
        function updateStarDisplay(rating) {
            const stars = document.querySelectorAll('.star-rating .star');
            stars.forEach((star, index) => { star.style.color = index < rating ? '#fbbf24' : '#d1d5db'; });
        }

        function setupReviewImageInputs() {
            const filesInput = document.getElementById('reviewImageFiles');
            const gallery = document.getElementById('reviewImageGallery');
            if (filesInput) {
                filesInput.addEventListener('change', async (e) => {
                    const files = Array.from(e.target.files || []);
                    for (const file of files) {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const dataUrl = reader.result;
                            reviewImageDataUrls.push(dataUrl);
                            addThumbToGallery(gallery, dataUrl);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            // video input setup
            const videoInput = document.getElementById('reviewVideoFile');
            const videoPreview = document.getElementById('reviewVideoPreview');
            if (videoInput) {
                videoInput.addEventListener('change', (e) => {
                    const file = e.target.files && e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = () => {
                        reviewVideoDataUrl = reader.result;
                        videoPreview.src = reviewVideoDataUrl;
                        videoPreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                });
            }
        }
        function addThumbToGallery(gallery, src) {
            if (!gallery) return;
            const wrap = document.createElement('div');
            wrap.className = 'review-thumb';
            const img = document.createElement('img'); img.src = src; img.alt = 'Review image';
            const btn = document.createElement('button'); btn.className = 'remove-thumb'; btn.innerHTML = '&times;';
            btn.onclick = function() {
                // remove from array
                reviewImageDataUrls = reviewImageDataUrls.filter(u => u !== src);
                gallery.removeChild(wrap);
            };
            wrap.appendChild(img); wrap.appendChild(btn); gallery.appendChild(wrap);
        }
        function clearReviewImages() {
            reviewImageDataUrls = [];
            const gallery = document.getElementById('reviewImageGallery'); if (gallery) gallery.innerHTML = '';
            const filesInput = document.getElementById('reviewImageFiles'); if (filesInput) filesInput.value = '';
        }
        window.clearReviewImages = clearReviewImages;
        function clearReviewVideo() {
            reviewVideoDataUrl = '';
            const videoPreview = document.getElementById('reviewVideoPreview'); if (videoPreview) { videoPreview.pause(); videoPreview.removeAttribute('src'); videoPreview.style.display = 'none'; }
            const videoInput = document.getElementById('reviewVideoFile'); if (videoInput) videoInput.value = '';
        }
        window.clearReviewVideo = clearReviewVideo;

        // Submit review (requires non-empty message)
        async function submitReview() {
            if (!currentUserId) { alert('Please login to submit a review'); window.location.href = '/Home/Login'; return; }
            const rating = parseInt(document.getElementById('reviewRating').value) || 0;
            const comment = (document.getElementById('reviewComment').value || '').trim();
            if (!comment) { alert('Please enter a review message.'); return; }
            if (rating === 0) { alert('Please select a rating'); return; }
            try {
                const payload = {
                    sellerId: sellerId,
                    sellerName: sellerName,
                    buyerId: currentUserId,
                    buyerName: currentUserName,
                    buyerUsername: currentUserUsername,
                    rating: rating,
                    comment: comment,
                    images: reviewImageDataUrls, // array of base64
                    video: reviewVideoDataUrl // base64
                };
                const result = await window.firebaseAddReview(payload);
                if (result.success) {
                    alert('Review submitted successfully!');
                    document.getElementById('reviewComment').value = '';
                    document.getElementById('reviewRating').value = '0'; selectedRating = 0; updateStarDisplay(0);
                    clearReviewImages();
                    clearReviewVideo();
                    loadReviews();
                } else {
                    alert('Failed to submit review: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                alert('Error submitting review. Please try again.');
            }
        }
        window.submitReview = submitReview;

        function createReviewCard(review) {
            const card = document.createElement('div'); card.className = 'review-card'; card.id = `review-${review.id}`;
            const buyerInitial = review.buyer_name ? review.buyer_name.charAt(0).toUpperCase() : 'U'; const createdDate = review.created_at ? new Date(review.created_at.seconds * 1000).toLocaleDateString() : 'Recently';
            let starsHTML = ''; for (let i = 0; i < 5; i++) { starsHTML += i < review.rating ? '<i class="bi bi-star-fill" style="color: #fbbf24;"></i>' : '<i class="bi bi-star" style="color: #d1d5db;"></i>'; }
            const canDelete = currentUserId === review.buyer_id;
            let galleryHtml = '';
            if (review.images && Array.isArray(review.images) && review.images.length > 0) {
                const thumbs = review.images.map(u => `<div class=\"review-thumb\"><img src=\"${u}\" onerror=\"this.style.display='none'\" /><button class=\"remove-thumb\" style=\"display:none\">&times;</button></div>`).join('');
                galleryHtml = `<div class=\"review-gallery mt-2\">${thumbs}</div>`;
            } else if (review.image) {
                galleryHtml = `<div class=\"mt-2\"><img src=\"${review.image}\" alt=\"Review image\" style=\"max-width:100%; border-radius:8px;\" onerror=\"this.style.display='none'\" /></div>`;
            }
            const videoHtml = review.video ? `<div class=\"mt-2\"><video controls style=\"max-width:100%; border-radius:8px;\" src=\"${review.video}\" onerror=\"this.style.display='none'\"></video></div>` : '';
            card.innerHTML = `
                <div class="review-header">
                    <div class="review-user-info">
                        <div class="review-avatar">${buyerInitial}</div>
                        <div class="review-user-details">
                            <h5 class="review-user-name">${review.buyer_name || 'Anonymous'}</h5>
                            <p class="review-username">@@${review.buyer_username || 'user'}</p>
                        </div>
                    </div>
                    <div class="review-actions">
                        ${canDelete ? `<button class="btn-delete-review" onclick="deleteReview('${review.id}')" title="Delete review"><i class="bi bi-trash"></i></button>` : ''}
                    </div>
                </div>
                <div class="review-rating">
                    ${starsHTML}
                    <span class="review-date">${createdDate}</span>
                </div>
                <div class="review-comment">${review.comment || '<em>No comment</em>'}</div>
                ${galleryHtml}
                ${videoHtml}
            `;
            return card;
        }

        function displayReviews(reviews) {
            const reviewsList = document.getElementById('reviewsList'); reviewsList.innerHTML = '';
            reviews.forEach(review => { const reviewCard = createReviewCard(review); reviewsList.appendChild(reviewCard); });
        }
        window.displayReviews = displayReviews;

        async function loadReviews() {
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = '<div class="loading-state"><div class="spinner-border" role="status"></div><p>Loading reviews...</p></div>';
            try {
                await checkUserTypeAndShowReviewForm();
                if (!sellerId) {
                    reviewsList.innerHTML = `
                        <div class="empty-tab-state">
                            <i class="bi bi-exclamation-circle" style="font-size: 3rem; color: #999;"></i>
                            <h4>No seller selected</h4>
                        </div>`;
                    return;
                }
                const timeoutPromise = new Promise((resolve) => setTimeout(() => resolve({ success: false, reviews: [], message: 'timeout' }), 6000));
                const fetchPromise = window.firebaseGetSellerReviews(sellerId);
                const result = await Promise.race([fetchPromise, timeoutPromise]);
                if (result.success && result.reviews && result.reviews.length > 0) {
                    window.displayReviews(result.reviews);
                } else {
                    reviewsList.innerHTML = `
                        <div class="empty-tab-state">
                            <i class="bi bi-star" style="font-size: 3rem; color: #ccc;"></i>
                            <h4>No Reviews Yet</h4>
                            <p>Be the first to review this seller</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
                const msg = (error && error.message) ? error.message : 'Please try again later';
                reviewsList.innerHTML = `
                    <div class="empty-tab-state">
                        <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #dc3545;"></i>
                        <h4>Error Loading Reviews</h4>
                        <p>${msg}</p>
                    </div>
                `;
            }
        }
        window.loadReviews = loadReviews;

        // Delete a review
        async function deleteReview(reviewId) {
            if (!confirm('Are you sure you want to delete this review?')) return;
            
            try {
                const result = await window.firebaseDeleteReview(reviewId, currentUserId);
                if (result.success) {
                    alert('Review deleted successfully');
                    loadReviews(); // Reload reviews
                } else {
                    alert('Failed to delete review: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting review:', error);
                alert('Error deleting review. Please try again.');
            }
        }
        window.deleteReview = deleteReview;

        // Review media viewer (seller page)
        function openSellerReviewMediaViewer(type, src) {
            const backdrop = document.getElementById('sellerReviewLightboxBackdrop');
            const box = document.getElementById('sellerReviewLightbox');
            if (!backdrop || !box) return;
            Array.from(box.children).forEach(ch => { if (ch.id !== 'sellerLightboxCloseBtn') ch.remove(); });
            let el;
            if (type === 'image') {
                el = document.createElement('img');
                el.src = src;
                el.alt = 'Review image';
                el.onerror = () => { el.style.display = 'none'; };
            } else if (type === 'video') {
                el = document.createElement('video');
                el.src = src;
                el.controls = true;
                el.autoplay = true;
                el.onerror = () => { el.style.display = 'none'; };
            }
            if (el) box.appendChild(el);
            backdrop.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        function closeSellerReviewMediaViewer() {
            const backdrop = document.getElementById('sellerReviewLightboxBackdrop');
            const box = document.getElementById('sellerReviewLightbox');
            if (!backdrop || !box) return;
            backdrop.style.display = 'none';
            const vid = box.querySelector('video'); if (vid) { vid.pause(); vid.src = ''; }
            document.body.style.overflow = '';
        }
        document.getElementById('sellerLightboxCloseBtn')?.addEventListener('click', closeSellerReviewMediaViewer);
        document.getElementById('sellerReviewLightboxBackdrop')?.addEventListener('click', (e)=>{ if (e.target.id === 'sellerReviewLightboxBackdrop') closeSellerReviewMediaViewer(); });
        
        function enableSellerReviewMediaClicks(root) {
            const container = root || document;
            container.querySelectorAll('#reviewsList .review-gallery .review-thumb img').forEach(img => {
                img.style.cursor = 'zoom-in';
                img.addEventListener('click', () => openSellerReviewMediaViewer('image', img.src));
            });
            container.querySelectorAll('#reviewsList video').forEach(video => {
                video.style.cursor = 'pointer';
                video.addEventListener('click', () => openSellerReviewMediaViewer('video', video.currentSrc || video.src));
            });
        }
        
        // Hook after reviews load
        const origDisplayReviews = window.displayReviews;
        window.displayReviews = function(reviews){
            if (origDisplayReviews) origDisplayReviews(reviews);
            enableSellerReviewMediaClicks(document.getElementById('reviewsList'));
        };
        document.addEventListener('DOMContentLoaded', () => enableSellerReviewMediaClicks());
        
        // Initialize on page load
        window.addEventListener('load', initializeSellerProfile);
    </script>
}

