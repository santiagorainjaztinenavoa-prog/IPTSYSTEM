@model IPTSYSTEM.Models.Listing
@{
    ViewData["Title"] = "Seller Profile";
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/seller-profile.css" asp-append-version="true" />
}

<!-- Seller Profile Page -->
<section class="seller-profile-page">
    <div class="container">
        <!-- Seller Header -->
        <div class="seller-header">
            <div class="seller-card-large">
                <div class="seller-avatar-large">
                    <span class="avatar-initial-large" id="sellerInitial">U</span>
                </div>
                <div class="seller-info-large">
                <h1 id="sellerName" class="seller-name-large">Seller Name</h1>
                <p id="sellerUsernameDisplay" class="seller-username-large"></p>
                <a href="#" id="sellerProfileDetailsLink" class="profile-username-link">Profile details <i class="bi bi-chevron-right"></i></a>
                    <div class="seller-stats">
                        <div class="stat">
                            <span class="stat-value" id="productCount">0</span>
                            <span class="stat-label">Products</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="ratingValue">4.5</span>
                            <span class="stat-label">Rating</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn-follow-seller" id="followBtn">
                        <i class="bi bi-person-plus"></i>
                        Follow
                    </button>
                    <button class="btn btn-outline-secondary" id="aboutBtn">
                        <i class="bi bi-info-circle"></i>
                        About
                    </button>
                </div>
            </div>
        </div>

        <!-- Seller Products Section -->
        <div class="seller-products-section">
            <div class="section-header">
                <h2>Products</h2>
                <div class="view-controls">
                    <select id="sortSelect" class="sort-select" onchange="changeSortOrder()">
                        <option value="newest">Newest</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                    </select>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="seller-products-grid" id="sellerProductsGrid">
                <div class="loading-spinner">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading products...</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- About Modal -->
<div class="modal fade" id="aboutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aboutTitle">About</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h6 class="mb-3">Account details</h6>
        <ul class="list-unstyled d-flex flex-column gap-2">
            <li class="d-flex align-items-center gap-2"><i class="bi bi-calendar"></i> <span id="joinedText">Joined —</span></li>
            <li class="d-flex align-items-center gap-2"><i class="bi bi-people"></i> <span id="socialText">0 Followers  ·  0 Following</span></li>
            <li class="d-flex align-items-center gap-2"><i class="bi bi-geo-alt"></i> <span id="locationText">—</span></li>
        </ul>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script src="~/js/firebase-client.js" type="module"></script>
    <script src="~/js/seller-products.js"></script>
    <script>
        // Get seller data from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const sellerId = urlParams.get('id');
        const sellerName = urlParams.get('name');
        const sellerUsername = urlParams.get('username');
        const sellerLocation = urlParams.get('location');

        const atSign = String.fromCharCode(64);

        // Initialize seller profile
        async function initializeSellerProfile() {
            if (!sellerId) {
                document.getElementById('sellerProductsGrid').innerHTML = '<p class="error">No seller selected</p>';
                return;
            }

            try {
                // Display seller info
                document.getElementById('sellerName').textContent = sellerName || 'Seller';
                const usernameDisplay = (sellerUsername || sellerId);
                document.getElementById('sellerUsernameDisplay').textContent = atSign + usernameDisplay;
                const initial = sellerName ? sellerName.charAt(0).toUpperCase() : 'U';
                document.getElementById('sellerInitial').textContent = initial;

                // About title
                document.getElementById('aboutTitle').textContent = 'About ' + atSign + usernameDisplay;

                // Fetch seller products
                const products = await window.sellerProductsManager.fetchSellerProducts(sellerId);
                document.getElementById('productCount').textContent = products.length;

                // Joined text based on earliest product date as a proxy
                let joinedText = 'Joined recently';
                if (products && products.length > 0) {
                    const dates = products.map(p => {
                        const d = p.date_created || p.created_at || p.CreatedDate;
                        if (!d) return null;
                        if (d && d.seconds) return new Date(d.seconds * 1000);
                        return new Date(d);
                    }).filter(Boolean);
                    if (dates.length) {
                        const earliest = new Date(Math.min.apply(null, dates));
                        joinedText = formatRelativeJoin(earliest);
                    }
                }
                document.getElementById('joinedText').textContent = joinedText;

                // Location
                document.getElementById('locationText').textContent = sellerLocation || 'Unknown City';

                if (products.length === 0) {
                    document.getElementById('sellerProductsGrid').innerHTML = 
                        '<p class="no-products">This seller has no products yet</p>';
                    return;
                }

                // Display products
                displaySellerProducts(products);
            } catch (error) {
                console.error('Error initializing seller profile:', error);
                document.getElementById('sellerProductsGrid').innerHTML = 
                    '<p class="error">Error loading seller products</p>';
            }
        }

        function formatRelativeJoin(date) {
            const now = new Date();
            const diffMs = now - date;
            const minutes = Math.floor(diffMs / 60000);
            const days = Math.floor(minutes / (60 * 24));
            const months = Math.floor(days / 30);
            const remDays = days - months * 30;
            return 'Joined ' + months + 'm ' + remDays + 'd';
        }

        function displaySellerProducts(products) {
            const grid = document.getElementById('sellerProductsGrid');
            grid.innerHTML = '';

            products.forEach(product => {
                const card = createProductCard(product);
                grid.appendChild(card);
            });
        }

        function createProductCard(product) {
            const conditionClass = ((product.condition || 'new') + '').toLowerCase().replace(' ', '-');
            const imageSrc = product.imageUrl || product.image_url || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop';
            const title = product.title || 'Untitled';
            const category = product.category || 'Uncategorized';
            const priceText = '?' + parseFloat(product.price || 0).toFixed(2);
            const productId = product.id || product.product_id;

            const html = 
                '<div class="product-image-container">' +
                    '<img src="' + imageSrc + '" alt="' + title + '" class="product-image" onerror="this.src=\'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop\'">' +
                    '<span class="condition-badge badge-' + conditionClass + '">' + (product.condition || 'New') + '</span>' +
                '</div>' +
                '<div class="product-info">' +
                    '<h3 class="product-title">' + title + '</h3>' +
                    '<p class="product-category">' + category + '</p>' +
                    '<p class="product-price">' + priceText + '</p>' +
                '</div>' +
                '<button class="btn-view-product" onclick="viewProduct(\'' + productId + '\')">' +
                    'View' +
                '</button>';

            const card = document.createElement('div');
            card.className = 'seller-product-card';
            card.innerHTML = html;
            return card;
        }

        function changeSortOrder() {
            const sortSelect = document.getElementById('sortSelect');
            const order = sortSelect.value;
            const products = window.sellerProductsManager.getSellerProducts();
            
            let sorted;
            if (order === 'newest') {
                sorted = window.sellerProductsManager.sortByDate(products, 'newest');
            } else if (order === 'price-low') {
                sorted = window.sellerProductsManager.sortByPrice(products, 'asc');
            } else if (order === 'price-high') {
                sorted = window.sellerProductsManager.sortByPrice(products, 'desc');
            }

            displaySellerProducts(sorted);
        }

        function viewProduct(productId) {
            // Redirect to product detail page
            window.location.href = '/Home/ProductDetail?id=' + productId;
        }

        function followSeller() {
            const btn = document.getElementById('followBtn');
            const isFollowing = btn.classList.toggle('following');
            btn.innerHTML = isFollowing ? 
                '<i class="bi bi-person-check"></i> Following' : 
                '<i class="bi bi-person-plus"></i> Follow';
        }

        document.getElementById('followBtn').addEventListener('click', followSeller);
        document.getElementById('aboutBtn').addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('aboutModal'));
            modal.show();
        });
        document.getElementById('sellerProfileDetailsLink').addEventListener('click', (e) => { e.preventDefault(); const modal = new bootstrap.Modal(document.getElementById('aboutModal')); modal.show(); });

        // Initialize on page load
        window.addEventListener('load', initializeSellerProfile);
    </script>
}
