@model List<IPTSYSTEM.Models.Listing>
@using System.Text.Json
@{
    ViewData["Title"] = "Browse";
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/browse.css" asp-append-version="true" />
}

<!-- Browse Page - Carousell Style Grid -->
<section class="browse-page">
    <div class="container-fluid p-0">
        <!-- Header with Search & Filters -->
        <div class="browse-header">
            <div class="browse-header-content">
                <h1 class="browse-title">Browse</h1>

                <!-- Search Bar and Filter on same row -->
                <div class="search-filter-row">
                    <!-- Search Bar -->
                    <div class="search-container">
                        <input type="text"
                               id="searchInput"
                               class="search-input"
                               placeholder="Search items..."
                               value="@ViewBag.Query"
                               onkeyup="if(event.key === 'Enter') applyFilters();">
                        <i class="bi bi-search search-icon"></i>
                    </div>

                    <!-- Category Filter -->
                    <div class="filter-container">
                        <select id="categoryFilter" class="filter-select" onchange="applyFilters()">
                            @{ var sel = (string)ViewBag.SelectedCategory ?? string.Empty; }
                            @if (string.Equals(sel, "Electronics", StringComparison.OrdinalIgnoreCase)) { <option value="Electronics" selected>Electronics</option> } else { <option value="Electronics">Electronics</option> }
                            @if (string.Equals(sel, "Fashion", StringComparison.OrdinalIgnoreCase)) { <option value="Fashion" selected>Fashion</option> } else { <option value="Fashion">Fashion</option> }
                            @if (string.Equals(sel, "Home & Living", StringComparison.OrdinalIgnoreCase)) { <option value="Home & Living" selected>Home & Living</option> } else { <option value="Home & Living">Home & Living</option> }
                            @if (string.Equals(sel, "Books", StringComparison.OrdinalIgnoreCase)) { <option value="Books" selected>Books</option> } else { <option value="Books">Books</option> }
                            @if (string.Equals(sel, "Sports", StringComparison.OrdinalIgnoreCase)) { <option value="Sports" selected>Sports</option> } else { <option value="Sports">Sports</option> }
                            @if (string.Equals(sel, "Toys & Games", StringComparison.OrdinalIgnoreCase)) { <option value="Toys & Games" selected>Toys & Games</option> } else { <option value="Toys & Games">Toys & Games</option> }
                            @if (string.Equals(sel, "Furniture", StringComparison.OrdinalIgnoreCase)) { <option value="Furniture" selected>Furniture</option> } else { <option value="Furniture">Furniture</option> }
                            @if (string.Equals(sel, "Beauty", StringComparison.OrdinalIgnoreCase)) { <option value="Beauty" selected>Beauty</option> } else { <option value="Beauty">Beauty</option> }
                            @if (string.IsNullOrWhiteSpace(sel)) { <option value="" selected>All Categories</option> } else { <option value="">All Categories</option> }
                        </select>
                    </div>

                    <!-- Sort Filter -->
                    <div class="filter-container">
                        <select id="sortFilter" class="filter-select" onchange="applyFilters()">
                            <option value="newest" selected>Newest First</option>
                            <option value="price-low">Price: Low to High</option>
                            <option value="price-high">Price: High to Low</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Listings Grid -->
        <div class="browse-grid" id="listingsContainer">
            <div class="loading-state">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading products...</p>
            </div>
        </div>
    </div>
</section>

<!-- Product Detail Modal -->
<div class="modal fade" id="productDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content product-detail-modal">
            <div class="modal-header border-0">
                <h2 class="modal-title" id="productTitle">Product Details</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Product Image Carousel -->
                <div class="product-detail-image mb-4">
                    <img id="detailProductImage" src="" alt="Product" class="img-fluid">
                    <span id="detailConditionBadge" class="condition-badge"></span>
                </div>

                <!-- Product Info -->
                <div class="product-detail-info">
                    <h3 id="detailProductTitle" class="product-detail-title"></h3>
                    <p id="detailProductCategory" class="product-detail-category"></p>
                    <h2 id="detailProductPrice" class="product-detail-price"></h2>
                    <p id="detailProductDescription" class="product-detail-description"></p>

                    <!-- Seller Card -->
                    <div class="seller-card">
                        <div class="seller-card-header">
                            <h4>Seller Information</h4>
                        </div>
                        <div class="seller-card-body">
                            <div class="seller-card-info">
                                <div class="seller-avatar-large">
                                    <span id="detailSellerAvatar" class="avatar-initial-large">U</span>
                                </div>
                                <div class="seller-details-full">
                                    <p id="detailSellerName" class="seller-name-full"></p>
                                    <p id="detailSellerUsername" class="seller-username-full"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Details -->
                    <div class="product-details-section">
                        <h4>Condition</h4>
                        <p id="detailConditionText" class="detail-value"></p>
                    </div>

                    <div class="product-details-section">
                        <h4>Posted on</h4>
                        <p id="detailPostedDate" class="detail-value"></p>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0 gap-2">
                <button type="button" class="btn-detail-message" onclick="messageSeller()">
                    <i class="bi bi-chat-dots"></i>
                    Message Seller
                </button>
                <button type="button" class="btn-detail-select" onclick="selectProduct()">
                    <i class="bi bi-check-circle"></i>
                    Select
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/firebase-client.js" type="module"></script>
    <script src="~/js/seller-products.js"></script>
    <script>
        // Use server-provided listings if available, otherwise fall back to firebase client
        let allProducts = @Html.Raw(JsonSerializer.Serialize(Model ?? new List<IPTSYSTEM.Models.Listing>()));
        let currentProductDetail = null;

        async function initializeBrowse() {
            try {
                // ✅ CHANGED: Don't load any products by default in Browse page
                // Browse page is now empty - users should use their Profile/My Listings to see their items
                console.log('Browse page initialized - showing empty state');
                
                const container = document.getElementById('listingsContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-inbox" style="font-size: 4rem; color: #d1d5db;"></i>
                            <h3>Browse Marketplace</h3>
                            <p>Products from sellers will appear here</p>
                        </div>
                    `;
                }
                
                // If you want to load products from Firestore later, uncomment this:
                // const res = await window.firebaseFetchAllProducts();
                // if (res && res.success && res.products) {
                //     allProducts = res.products;
                //     applyFilters(false);
                // }
            } catch (err) {
                console.error('Browse init error', err);
            }
        }

        // Apply filters client-side and optionally update the URL without reloading
        function applyFilters(updateUrl = true) {
            const q = document.getElementById('searchInput').value.trim().toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const sort = document.getElementById('sortFilter').value;

            const filtered = (allProducts || []).filter(p => {
                const title = (p.title ?? p.Title ?? '').toString().toLowerCase();
                const description = (p.description ?? p.Description ?? '').toString().toLowerCase();
                const cat = (p.category ?? p.Category ?? '').toString();

                const matchesQuery = !q || title.includes(q) || description.includes(q);
                const matchesCategory = !category || category === '' || cat.toLowerCase() === category.toLowerCase();

                return matchesQuery && matchesCategory;
            });

            // Sort the filtered results
            filtered.sort((a, b) => {
                if (sort === 'price-low') {
                    return (a.price ?? a.Price ?? 0) - (b.price ?? b.Price ?? 0);
                } else if (sort === 'price-high') {
                    return (b.price ?? b.Price ?? 0) - (a.price ?? a.Price ?? 0);
                } else {
                    // Default to newest first (assuming date_created is available and in proper format)
                    return (b.date_created?.seconds || 0) - (a.date_created?.seconds || 0);
                }
            });

            displayProducts(filtered);

            if (updateUrl) {
                const params = new URLSearchParams();
                if (q) params.set('q', q);
                if (category) params.set('category', category);
                const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
                history.replaceState(null, '', newUrl);
            }
        }

        function displayProducts(products) {
            const container = document.getElementById('listingsContainer');
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h3>No listings found</h3>
                        <p>Try adjusting your filters or search term</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            products.forEach(product => {
                const card = createProductCard(product);
                container.appendChild(card);
            });
        }

        // re-use existing client-side helpers
        function createProductCard(product = {}) {
            const id = product.id ?? product.Id;
            const title = product.title ?? product.Title;
            const description = product.description ?? product.Description;
            const price = product.price ?? product.Price;
            const category = product.category ?? product.Category;
            const condition = product.condition ?? product.Condition ?? 'New';
            const imageUrl = product.imageUrl ?? product.image_url ?? product.ImageUrl ?? 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop';
            const sellerName = product.full_name ?? product.SellerFullName ?? product.seller_name ?? product.username ?? product.SellerUsername ?? 'Unknown Seller';
            const sellerUsername = product.username ?? product.SellerUsername ?? product.user_email ?? '';
            const sellerId = product.user_id ?? product.SellerUserId ?? '';
            const sellerInitial = sellerName ? sellerName.charAt(0).toUpperCase() : 'U';

            const card = document.createElement('div');
            card.className = 'listing-card';
            card.id = `listing-${id}`;
            card.setAttribute('data-category', category || '');
            card.setAttribute('data-title', title || '');
            card.setAttribute('data-description', description || '');

            const conditionClass = condition.toLowerCase().replace(/\s+/g, '-');

            const html = `
                <div class="listing-image-wrapper">
                    <img src="${imageUrl}" alt="${title || 'Product'}" class="listing-image" onclick="openProductDetail('${id}')" onerror="this.src='https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop'">
                    <span class="condition-badge badge-${conditionClass}">${condition}</span>
                </div>
                <div class="listing-seller-info">
                    <div class="seller-avatar"><span class="avatar-initial">${sellerInitial}</span></div>
                    <div class="seller-details">
                        <p class="seller-name">${sellerName}</p>
                        <p class="seller-username">${sellerUsername}</p>
                    </div>
                    <a href="/Home/SellerProfile?id=${sellerId}&name=${encodeURIComponent(sellerName)}&username=${encodeURIComponent(sellerUsername)}" class="seller-link" title="View seller profile"></a>
                </div>
                <div class="listing-body">
                    <h3 class="listing-title">${title || 'Untitled'}</h3>
                    <p class="listing-description">${(description || 'No description available').substring(0, 80)}${(description || '').length > 80 ? '...' : ''}</p>
                    <p class="listing-category">${category || 'Uncategorized'}</p>
                    <p class="listing-price">₱${parseFloat(price || 0).toFixed(2)}</p>
                </div>
                <div class="listing-buttons">
                    <button class="btn-message" onclick="openProductDetail('${id}'); setTimeout(() => messageSeller(), 500)">Message</button>
                    <button class="btn-select" onclick="openProductDetail('${id}')">Select</button>
                </div>
            `;

            card.innerHTML = html;
            return card;
        }

        function openProductDetail(productId) {
            const product = allProducts.find(p => (p.id && p.id == productId) || (p.Id && p.Id == productId));
            if (!product) return;

            const condition = product.condition ?? product.Condition ?? 'New';
            const sellerName = product.full_name ?? product.SellerFullName ?? 'Unknown Seller';
            const sellerUsername = product.username ?? product.SellerUsername ?? '';
            const sellerInitial = sellerName ? sellerName.charAt(0).toUpperCase() : 'U';
            const imageUrl = product.imageUrl ?? product.image_url ?? product.ImageUrl ?? 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop';
            const conditionClass = condition.toLowerCase().replace(/\s+/g, '-');

            document.getElementById('productTitle').textContent = product.title ?? product.Title ?? 'Product';
            document.getElementById('detailProductTitle').textContent = product.title ?? product.Title ?? 'Product';
            document.getElementById('detailProductCategory').textContent = product.category ?? product.Category ?? 'Uncategorized';
            document.getElementById('detailProductPrice').textContent = `₱${parseFloat(product.price ?? product.Price ?? 0).toFixed(2)}`;
            document.getElementById('detailProductDescription').textContent = product.description ?? product.Description ?? 'No description available';
            document.getElementById('detailProductImage').src = imageUrl;
            document.getElementById('detailConditionBadge').textContent = condition;
            document.getElementById('detailConditionBadge').className = `condition-badge badge-${conditionClass}`;
            document.getElementById('detailConditionText').textContent = condition;
            document.getElementById('detailSellerName').textContent = sellerName;
            document.getElementById('detailSellerUsername').textContent = sellerUsername;
            document.getElementById('detailSellerAvatar').textContent = sellerInitial;

            const createdDate = product.date_created ? (product.date_created.seconds ? new Date(product.date_created.seconds * 1000).toLocaleDateString() : new Date(product.date_created).toLocaleDateString()) : new Date().toLocaleDateString();
            document.getElementById('detailPostedDate').textContent = createdDate;

            currentProductDetail = { id: productId, title: product.title ?? product.Title, sellerName, sellerUsername };
            const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
            modal.show();
        }

        function messageSeller() { if (currentProductDetail) alert(`Message seller: ${currentProductDetail.sellerName}`); }
        function selectProduct() { if (currentProductDetail) alert(`Selected: ${currentProductDetail.title}`); }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeBrowse);
    </script>
}
