@model List<IPTSYSTEM.Models.Listing>
@using System.Text.Json
@{
    ViewData["Title"] = "Browse";
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/browse.css" asp-append-version="true" />
}

<!-- Browse Page - Carousell Style Grid -->
<section class="browse-page">
    <div class="container-fluid p-0">
        <!-- Header with Search & Filters -->
        <div class="browse-header">
            <div class="browse-header-content">
                <h1 class="browse-title">Browse</h1>

                <!-- Search Bar and Filter on same row -->
                <div class="search-filter-row">
                    <!-- Search Bar -->
                    <div class="search-container">
                        <input type="text"
                               id="searchInput"
                               class="search-input"
                               placeholder="Search items..."
                               value="@ViewBag.Query"
                               onkeyup="if(event.key === 'Enter') applyFilters();">
                        <i class="bi bi-search search-icon"></i>
                    </div>

                    <!-- Category Filter -->
                    <div class="filter-container">
                        <select id="categoryFilter" class="filter-select" onchange="applyFilters()">
                            @{ var sel = (string)ViewBag.SelectedCategory ?? string.Empty; }
                            @if (string.Equals(sel, "Electronics", StringComparison.OrdinalIgnoreCase)) { <option value="Electronics" selected>Electronics</option> } else { <option value="Electronics">Electronics</option> }
                            @if (string.Equals(sel, "Fashion", StringComparison.OrdinalIgnoreCase)) { <option value="Fashion" selected>Fashion</option> } else { <option value="Fashion">Fashion</option> }
                            @if (string.Equals(sel, "Home & Living", StringComparison.OrdinalIgnoreCase)) { <option value="Home & Living" selected>Home & Living</option> } else { <option value="Home & Living">Home & Living</option> }
                            @if (string.Equals(sel, "Books", StringComparison.OrdinalIgnoreCase)) { <option value="Books" selected>Books</option> } else { <option value="Books">Books</option> }
                            @if (string.Equals(sel, "Sports", StringComparison.OrdinalIgnoreCase)) { <option value="Sports" selected>Sports</option> } else { <option value="Sports">Sports</option> }
                            @if (string.Equals(sel, "Toys & Games", StringComparison.OrdinalIgnoreCase)) { <option value="Toys & Games" selected>Toys & Games</option> } else { <option value="Toys & Games">Toys & Games</option> }
                            @if (string.Equals(sel, "Furniture", StringComparison.OrdinalIgnoreCase)) { <option value="Furniture" selected>Furniture</option> } else { <option value="Furniture">Furniture</option> }
                            @if (string.Equals(sel, "Beauty", StringComparison.OrdinalIgnoreCase)) { <option value="Beauty" selected>Beauty</option> } else { <option value="Beauty">Beauty</option> }
                            @if (string.IsNullOrWhiteSpace(sel)) { <option value="" selected>All Categories</option> } else { <option value="">All Categories</option> }
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Listings Grid -->
        <div class="browse-grid" id="listingsContainer">
            <div class="loading-state">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading products...</p>
            </div>
        </div>
    </div>
</section>

<!-- Product Detail Modal -->
<div class="modal fade" id="productDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content product-detail-modal">
            <div class="modal-header border-0">
                <h2 class="modal-title" id="productTitle">Product Details</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Product Image Carousel -->
                <div class="product-detail-image mb-4">
                    <img id="detailProductImage" src="" alt="Product" class="img-fluid">
                    <span id="detailConditionBadge" class="condition-badge"></span>
                </div>

                <!-- Product Info -->
                <div class="product-detail-info">
                    <h3 id="detailProductTitle" class="product-detail-title"></h3>
                    <p id="detailProductCategory" class="product-detail-category"></p>
                    <h2 id="detailProductPrice" class="product-detail-price"></h2>
                    <p id="detailProductDescription" class="product-detail-description"></p>

                    <!-- Seller Card -->
                    <div class="seller-card">
                        <div class="seller-card-header">
                            <h4>Seller Information</h4>
                        </div>
                        <div class="seller-card-body">
                            <div class="seller-card-info">
                                <div class="seller-avatar-large">
                                    <span id="detailSellerAvatar" class="avatar-initial-large">U</span>
                                </div>
                                <div class="seller-details-full">
                                    <p id="detailSellerName" class="seller-name-full"></p>
                                    <p id="detailSellerUsername" class="seller-username-full"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Details -->
                    <div class="product-details-section">
                        <h4>Condition</h4>
                        <p id="detailConditionText" class="detail-value"></p>
                    </div>

                    <div class="product-details-section">
                        <h4>Posted on</h4>
                        <p id="detailPostedDate" class="detail-value"></p>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0 gap-2">
                <button type="button" class="btn-detail-message" onclick="messageSeller()">
                    <i class="bi bi-chat-dots"></i>
                    Message Seller
                </button>
                <button type="button" class="btn-detail-select" onclick="selectProduct()">
                    <i class="bi bi-check-circle"></i>
                    Select
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast for save notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11000">
    <div id="saveToast" class="toast align-items-center border-0 bg-success text-white" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="saveToastMessage">Product saved!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/firebase-client.js" type="module"></script>
    <script src="~/js/seller-products.js"></script>
    <script>
        // Use server-provided listings if available, otherwise fall back to firebase client
        let allProducts = @Html.Raw(JsonSerializer.Serialize(Model ?? new List<IPTSYSTEM.Models.Listing>()));
        let currentProductDetail = null;

        async function initializeBrowse() {
            try {
                // Load saved product IDs first
                await loadSavedProductIds();
                
                if (!allProducts || allProducts.length === 0) {
                    // fallback to firebase client
                    const res = await window.firebaseFetchAllProducts();
                    if (res && res.success && res.products) {
                        allProducts = res.products;
                    }
                }
                displayProducts(allProducts);
            } catch (err) {
                console.error('Browse init error', err);
            }
        }

        function applyFilters() {
            const q = document.getElementById('searchInput').value.trim();
            const category = document.getElementById('categoryFilter').value;
            const params = new URLSearchParams();
            if (q) params.set('q', q);
            if (category) params.set('category', category);
            window.location.search = params.toString();
        }

        function displayProducts(products) {
            const container = document.getElementById('listingsContainer');
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h3>No listings found</h3>
                        <p>Try adjusting your filters or search term</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            products.forEach(product => {
                const card = createProductCard(product);
                container.appendChild(card);
            });
        }

        // re-use existing client-side helpers
        // Track saved product IDs for quick lookup
        let savedProductIds = new Set();
        const currentUserId = '@(Context.Session.GetString("UserId") ?? "")';

        function createProductCard(product) {
            const id = product.id ?? product.Id;
            const title = product.title ?? product.Title;
            const description = product.description ?? product.Description;
            const price = product.price ?? product.Price;
            const category = product.category ?? product.Category;
            const condition = product.condition ?? product.Condition ?? 'New';
            const imageUrl = product.imageUrl ?? product.image_url ?? product.ImageUrl ?? 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop';
            const sellerName = product.full_name ?? product.SellerFullName ?? product.seller_name ?? product.username ?? product.SellerUsername ?? 'Unknown Seller';
            const sellerUsername = product.username ?? product.SellerUsername ?? product.user_email ?? '';
            const sellerId = product.user_id ?? product.SellerUserId ?? '';
            const sellerInitial = sellerName ? sellerName.charAt(0).toUpperCase() : 'U';
            const isSaved = savedProductIds.has(id);

            const card = document.createElement('div');
            card.className = 'listing-card';
            card.id = `listing-${id}`;
            card.setAttribute('data-category', category || '');
            card.setAttribute('data-title', title || '');
            card.setAttribute('data-description', description || '');

            const conditionClass = condition.toLowerCase().replace(/\s+/g, '-');

            const html = `
                <div class="listing-image-wrapper">
                    <img src="${imageUrl}" alt="${title || 'Product'}" class="listing-image" onclick="openProductDetail('${id}')" onerror="this.src='https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop'">
                    <span class="condition-badge badge-${conditionClass}">${condition}</span>
                    <button class="save-btn ${isSaved ? 'saved' : ''}" onclick="toggleSaveProduct(event, '${id}')" title="${isSaved ? 'Remove from saved' : 'Save product'}">
                        <i class="bi ${isSaved ? 'bi-heart-fill' : 'bi-heart'}"></i>
                    </button>
                </div>
                <div class="listing-seller-info">
                    <div class="seller-avatar"><span class="avatar-initial">${sellerInitial}</span></div>
                    <div class="seller-details">
                        <p class="seller-name">${sellerName}</p>
                        <p class="seller-username">${sellerUsername}</p>
                    </div>
                    <a href="/Home/SellerProfile?id=${sellerId}&name=${encodeURIComponent(sellerName)}&username=${encodeURIComponent(sellerUsername)}" class="seller-link" title="View seller profile"></a>
                </div>
                <div class="listing-body">
                    <h3 class="listing-title">${title || 'Untitled'}</h3>
                    <p class="listing-description">${(description || 'No description available').substring(0, 80)}${(description || '').length > 80 ? '...' : ''}</p>
                    <p class="listing-category">${category || 'Uncategorized'}</p>
                    <p class="listing-price">‚Ç±${parseFloat(price || 0).toFixed(2)}</p>
                </div>
                <div class="listing-buttons">
                    <button class="btn-message" onclick="openProductDetail('${id}'); setTimeout(() => messageSeller(), 500)">Message</button>
                    <button class="btn-select" onclick="openProductDetail('${id}')">Select</button>
                </div>
            `;

            card.innerHTML = html;
            return card;
        }

        // Toggle save/unsave product
        async function toggleSaveProduct(event, productId) {
            event.stopPropagation();
            
            console.log('üîÑ Toggle save for product:', productId);
            console.log('üë§ Current user ID:', currentUserId);
            
            if (!currentUserId) {
                alert('Please login to save products');
                window.location.href = '/Home/Login';
                return;
            }
            
            const btn = event.currentTarget;
            const icon = btn.querySelector('i');
            const product = allProducts.find(p => (p.id && p.id == productId) || (p.Id && p.Id == productId));
            
            if (!product) {
                console.error('‚ùå Product not found:', productId);
                showToast('Product not found', 'error');
                return;
            }
            
            console.log('üì¶ Found product:', product);
            
            // Disable button during operation
            btn.disabled = true;
            
            // Wait for Firebase to be ready
            let retries = 0;
            while (typeof window.firebaseToggleSaveProduct !== 'function' && retries < 20) {
                await new Promise(r => setTimeout(r, 200));
                retries++;
            }
            
            if (typeof window.firebaseToggleSaveProduct !== 'function') {
                console.error('‚ùå Firebase functions not available');
                showToast('Service not ready. Please refresh.', 'error');
                btn.disabled = false;
                return;
            }
            
            try {
                const productData = {
                    title: product.title ?? product.Title ?? '',
                    price: product.price ?? product.Price ?? 0,
                    imageUrl: product.imageUrl ?? product.image_url ?? product.ImageUrl ?? '',
                    category: product.category ?? product.Category ?? '',
                    condition: product.condition ?? product.Condition ?? '',
                    sellerName: product.full_name ?? product.SellerFullName ?? product.seller_name ?? '',
                    sellerUsername: product.username ?? product.SellerUsername ?? '',
                    sellerId: product.user_id ?? product.SellerUserId ?? ''
                };
                
                console.log('üì§ Sending product data:', productData);
                
                const result = await window.firebaseToggleSaveProduct(currentUserId, productId, productData);
                
                console.log('üì• Toggle result:', result);
                
                if (result.success) {
                    if (result.isSaved) {
                        savedProductIds.add(productId);
                        btn.classList.add('saved');
                        icon.className = 'bi bi-heart-fill';
                        btn.title = 'Remove from saved';
                        showToast('Product saved!', 'success');
                    } else {
                        savedProductIds.delete(productId);
                        btn.classList.remove('saved');
                        icon.className = 'bi bi-heart';
                        btn.title = 'Save product';
                        showToast('Product removed from saved', 'info');
                    }
                    // Update saved count badge
                    updateSavedBadge();
                } else {
                    console.error('‚ùå Toggle failed:', result.message);
                    showToast('Error: ' + (result.message || 'Failed to save'), 'error');
                }
            } catch (err) {
                console.error('‚ùå Error toggling save:', err);
                showToast('Error saving product: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }
        
        // Load saved product IDs on init
        async function loadSavedProductIds() {
            if (!currentUserId) return;
            
            try {
                const result = await window.firebaseGetSavedProductIds(currentUserId);
                if (result.success && result.savedIds) {
                    savedProductIds = new Set(result.savedIds);
                    updateSavedBadge();
                }
            } catch (err) {
                console.error('Error loading saved products:', err);
            }
        }
        
        // Update saved products badge
        function updateSavedBadge() {
            const badge = document.querySelector('.saved-icon .icon-badge');
            if (badge) {
                badge.textContent = savedProductIds.size;
                badge.style.display = savedProductIds.size > 0 ? 'flex' : 'none';
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('saveToast');
            const toastBody = document.getElementById('saveToastMessage');
            if (toast && toastBody) {
                toastBody.textContent = message;
                toast.className = `toast align-items-center border-0 bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} text-white`;
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            }
        }

        function openProductDetail(productId) {
            const product = allProducts.find(p => (p.id && p.id == productId) || (p.Id && p.Id == productId));
            if (!product) return;

            const condition = product.condition ?? product.Condition ?? 'New';
            const sellerName = product.full_name ?? product.SellerFullName ?? 'Unknown Seller';
            const sellerUsername = product.username ?? product.SellerUsername ?? '';
            const sellerInitial = sellerName ? sellerName.charAt(0).toUpperCase() : 'U';
            const imageUrl = product.imageUrl ?? product.image_url ?? product.ImageUrl ?? 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop';
            const conditionClass = condition.toLowerCase().replace(/\s+/g, '-');

            document.getElementById('productTitle').textContent = product.title ?? product.Title ?? 'Product';
            document.getElementById('detailProductTitle').textContent = product.title ?? product.Title ?? 'Product';
            document.getElementById('detailProductCategory').textContent = product.category ?? product.Category ?? 'Uncategorized';
            document.getElementById('detailProductPrice').textContent = `‚Ç±${parseFloat(product.price ?? product.Price ?? 0).toFixed(2)}`;
            document.getElementById('detailProductDescription').textContent = product.description ?? product.Description ?? 'No description available';
            document.getElementById('detailProductImage').src = imageUrl;
            document.getElementById('detailConditionBadge').textContent = condition;
            document.getElementById('detailConditionBadge').className = `condition-badge badge-${conditionClass}`;
            document.getElementById('detailConditionText').textContent = condition;
            document.getElementById('detailSellerName').textContent = sellerName;
            document.getElementById('detailSellerUsername').textContent = sellerUsername;
            document.getElementById('detailSellerAvatar').textContent = sellerInitial;

            const createdDate = product.date_created ? (product.date_created.seconds ? new Date(product.date_created.seconds * 1000).toLocaleDateString() : new Date(product.date_created).toLocaleDateString()) : new Date().toLocaleDateString();
            document.getElementById('detailPostedDate').textContent = createdDate;

            currentProductDetail = { id: productId, title: product.title ?? product.Title, sellerName, sellerUsername };
            const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
            modal.show();
        }

        async function messageSeller() { 
            if (!currentProductDetail) return;
            
            // Get current user info from session (passed from server)
            const buyerId = '@(Context.Session.GetString("UserId") ?? "")';
            const buyerName = '@(Context.Session.GetString("FullName") ?? Context.Session.GetString("Username") ?? "")';
            
            if (!buyerId) {
                alert('Please login to message the seller');
                window.location.href = '/Home/Login';
                return;
            }
            
            // Find the full product to get seller info
            const product = allProducts.find(p => (p.id && p.id == currentProductDetail.id) || (p.Id && p.Id == currentProductDetail.id));
            if (!product) {
                alert('Product not found');
                return;
            }
            
            const sellerId = product.user_id ?? product.SellerUserId ?? '';
            const sellerName = product.full_name ?? product.SellerFullName ?? product.seller_name ?? 'Seller';
            const listingId = (product.id ?? product.Id ?? '').toString();
            const listingTitle = product.title ?? product.Title ?? 'Item';
            
            if (!sellerId) {
                alert('Seller information not available');
                return;
            }
            
            if (buyerId === sellerId) {
                alert('You cannot message yourself');
                return;
            }
            
            // Use client-side Firebase to start conversation
            if (typeof window.firebaseStartConversation === 'function') {
                try {
                    const result = await window.firebaseStartConversation(
                        buyerId, buyerName, sellerId, sellerName, listingId, listingTitle
                    );
                    
                    if (result.success && result.conversation) {
                        // Redirect to messages page with conversation ID
                        window.location.href = '/Home/Messages?conversationId=' + result.conversation.id;
                    } else {
                        alert('Failed to start conversation: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error starting conversation:', error);
                    alert('Error starting conversation. Please try again.');
                }
            } else {
                alert('Messaging service not available. Please refresh the page.');
            }
        }
        function selectProduct() { if (currentProductDetail) alert(`Selected: ${currentProductDetail.title}`); }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeBrowse);
    </script>
}
