@model IPTSYSTEM.Models.UserProfileViewModel
@{
    ViewData["Title"] = "My Profile";
    var initial = string.IsNullOrWhiteSpace(Model.FullName)
        ? (string.IsNullOrWhiteSpace(Model.Username) ? "?" : Model.Username.Substring(0,1).ToUpperInvariant())
        : Model.FullName.Substring(0,1).ToUpperInvariant();
    
    // Calculate days since joined
    var daysSinceJoined = 12;
    var joinedText = daysSinceJoined < 30 ? $"{daysSinceJoined}d" : $"{daysSinceJoined / 30}m {daysSinceJoined % 30}d";
    
    var userType = Context.Session.GetString("UserType") ?? "buyer";
    var username = Context.Session.GetString("Username") ?? "";
    var fullName = Context.Session.GetString("FullName") ?? "";
    var userId = Context.Session.GetString("UserId") ?? "";
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/profile.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/pages/mylistings.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/listing-form.css" asp-append-version="true" />
    <style>
        /* Smooth modal animations */
        .modal.fade .modal-dialog {
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
            transform: scale(0.7) translateY(-30px);
            opacity: 0;
        }
        
        .modal.show .modal-dialog {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        
        .modal-backdrop.fade {
            transition: opacity 0.3s ease;
        }
        
        .modal-backdrop.show {
            opacity: 0.6;
        }
        
        /* Sold out items in history - grayscale and lower opacity */
        .sold-item {
            filter: grayscale(100%);
            opacity: 0.6;
            transition: all 0.3s ease;
        }
        
        .sold-item:hover {
            opacity: 0.8;
        }
        
        .sold-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(220, 38, 38, 0.95);
            color: white;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Button hover animations */
        #confirmSoldBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5) !important;
        }
        
        #confirmDeleteBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.5) !important;
        }
        
        .modal .btn:hover {
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        /* Review media gallery styles */
        .review-gallery { display:flex; flex-wrap:wrap; gap:8px; }
        .review-thumb { width:96px; height:96px; border-radius:8px; background:#f3f4f6; overflow:hidden; display:flex; align-items:center; justify-content:center; position:relative; }
        .review-thumb img { max-width:100%; max-height:100%; object-fit:cover; }
        .video-preview { max-width:320px; border-radius:8px; background:#f3f4f6; }

        /* Lightbox styles */
        .review-lightbox-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.8); display:none; align-items:center; justify-content:center; z-index: 1056; }
        .review-lightbox { max-width: 90vw; max-height: 85vh; border-radius: 12px; overflow:hidden; box-shadow: 0 20px 60px rgba(0,0,0,.4); background:#000; position:relative; }
        .review-lightbox img, .review-lightbox video { max-width: 90vw; max-height: 85vh; display:block; }
        .lightbox-close { position:absolute; top:8px; right:8px; background: rgba(255,255,255,.15); border:none; color:#fff; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; }
        .lightbox-close:hover { background: rgba(255,255,255,.3); }
    </style>
}

<!-- Lightbox for review media -->
<div id="reviewLightboxBackdrop" class="review-lightbox-backdrop">
    <div class="review-lightbox" id="reviewLightbox">
        <button class="lightbox-close" id="lightboxCloseBtn" aria-label="Close"><i class="bi bi-x-lg"></i></button>
        <!-- content injected dynamically -->
    </div>
</div>

<section class="profile-page py-4" 
         data-user-name="@username"
         data-user-fullname="@fullName"
         data-user-id="@userId"
         data-user-type="@userType">
    <div class="container">
        <!-- Profile Header -->
        <div class="profile-header-section">
            <div class="profile-header-content">
                <div id="profileAvatar" class="profile-avatar-large">@initial</div>
                <div class="profile-info-section">
                    <div class="profile-name-row">
                        <h1 class="profile-name">@(string.IsNullOrWhiteSpace(Model.FullName) ? Model.Username : Model.FullName)</h1>
                        <span class="profile-verified-badge">Not verified</span>
                    </div>
                    <a href="#" id="profileDetailsLink" class="profile-username-link">
                        Profile details <i class="bi bi-chevron-right"></i>
                    </a>
                    <div class="profile-meta-stats">
                        <div class="profile-meta-item">
                            <span class="profile-meta-value">N/A</span>
                            <span class="profile-meta-label">No review yet</span>
                        </div>
                        <div class="profile-meta-item">
                            <span class="profile-meta-value">@joinedText</span>
                            <span class="profile-meta-label">Joined</span>
                        </div>
                    </div>
                </div>
                <div class="profile-actions">
                    <a href="@Url.Action("AccountSettings", "Home")" class="btn btn-edit-profile">Edit Profile</a>
                    <button class="btn btn-share-profile" title="Share profile" onclick="shareProfile()">
                        <i class="bi bi-upload"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Profile Tabs with Add Button -->
        <div class="profile-tabs-section">
            <div class="d-flex justify-content-between align-items-center" style="padding: 0 40px;">
                <div class="profile-tabs">
                    @if (userType.ToLower() == "buyer")
                    {
                        <button class="profile-tab active" data-tab="listings" onclick="switchTab('listings')">Listings</button>
                        <button class="profile-tab" data-tab="review" onclick="switchTab('review')">Reviews</button>
                    }
                    else
                    {
                        <button class="profile-tab active" data-tab="listings" onclick="switchTab('listings')">Listings</button>
                        <button class="profile-tab" data-tab="history" onclick="switchTab('history')">History</button>
                        <button class="profile-tab" data-tab="reports" onclick="switchTab('reports')">Reports</button>
                        <button class="profile-tab" data-tab="review" onclick="switchTab('review')">Review</button>
                    }
                </div>
                @if (userType == "seller" || userType == "admin")
                {
                    <button class="btn-add-new" id="addNewListingBtn" onclick="openListingModal()" style="margin: 12px 0;">
                        <i class="bi bi-plus-circle me-2"></i>
                        Add New Listing
                    </button>
                }
            </div>
        </div>
        
        <!-- Tab Contents -->
        <div class="profile-content-section">
            <!-- Listings Content (For Both Buyer and Seller) -->
            <div class="tab-content active" id="listingsContent">
                <div class="listings-grid" id="listingsContainer">
                    <!-- Skeleton Loader -->
                    <div class="listing-card listing-skeleton" style="height: 300px;"></div>
                    <div class="listing-card listing-skeleton" style="height: 300px;"></div>
                    <div class="listing-card listing-skeleton" style="height: 300px;"></div>
                    <div class="listing-card listing-skeleton" style="height: 300px;"></div>
                </div>
            </div>

            <!-- History Content -->
            <div class="tab-content" id="historyContent">
                <div class="empty-tab-state">
                    <i class="bi bi-clock-history" style="font-size: 4rem; color: #ccc;"></i>
                    <h3>Purchase History</h3>
                    <p>Your transaction history will appear here</p>
                </div>
            </div>

            <!-- Reports Content -->
            <div class="tab-content" id="reportsContent">
                <div class="empty-tab-state">
                    <i class="bi bi-file-earmark-text" style="font-size: 4rem; color: #ccc;"></i>
                    <h3>Reports</h3>
                    <p>View your sales reports and analytics here</p>
                </div>
            </div>

            <!-- Review Content -->
            <div class="tab-content" id="reviewContent">
                <div class="reviews-container" id="reviewsContainer">
                    <div class="loading-state">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading reviews...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Profile Details Modal -->
<div class="modal fade" id="profileDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">About @Model.Username</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h6 class="mb-3">Account details</h6>
        <ul class="list-unstyled d-flex flex-column gap-2">
            <li class="d-flex align-items-center gap-2"><i class="bi bi-calendar"></i> <span>Joined @joinedText</span></li>
            <li class="d-flex align-items-center gap-2"><i class="bi bi-geo-alt"></i> <span id="profileLocation">@(Model.City ?? "Unknown City")</span></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modals -->
<!-- Sold Out Confirmation Modal -->
<div class="modal fade" id="soldOutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div class="modal-header border-0" style="padding: 24px 24px 0;">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #10b981 0%, #16a34a 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-check-circle-fill" style="font-size: 24px; color: white;"></i>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 20px 24px 24px;">
                <h5 class="mb-2" style="font-weight: 700; color: #1a1a1a;">Mark as Sold Out?</h5>
                <p class="text-muted mb-0" style="font-size: 0.95rem;">
                    <span id="soldOutItemTitle" style="font-weight: 600; color: #16a34a;"></span> will be moved to your history and removed from Browse.
                </p>
            </div>
            <div class="modal-footer border-0" style="padding: 0 24px 24px; gap: 12px;">
                <button type="button" class="btn" data-bs-dismiss="modal" style="flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; background: #f3f4f6; color: #6b7280; border: none;">
                    Cancel
                </button>
                <button type="button" class="btn" id="confirmSoldBtn" style="flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; background: linear-gradient(135deg, #10b981 0%, #16a34a 100%); color: white; border: none; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);">
                    <i class="bi bi-check-circle me-2"></i>Mark as Sold
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div class="modal-header border-0" style="padding: 24px 24px 0;">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-trash-fill" style="font-size: 24px; color: white;"></i>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 20px 24px 24px;">
                <h5 class="mb-2" style="font-weight: 700; color: #1a1a1a;">Delete Listing?</h5>
                <p class="text-muted mb-0" style="font-size: 0.95rem;">
                    Are you sure you want to delete <span id="deleteItemTitle" style="font-weight: 600, color: #dc2626;"></span>? This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer border-0" style="padding: 0 24px 24px; gap: 12px;">
                <button type="button" class="btn" data-bs-dismiss="modal" style="flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; background: #f3f4f6; color: #6b7280; border: none;">
                    Cancel
                </button>
                <button type="button" class="btn" id="confirmDeleteBtn" style="flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);">
                    <i class="bi bi-trash me-2"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Listing Modal -->
<div class="modal fade" id="listingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content modern-modal">
            <div class="modal-header border-0">
                <div>
                    <h2 class="modal-title" id="modalTitle">Add New Listing</h2>
                    <p class="modal-subtitle">Fill in the details below</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="listingForm">
                    <input type="hidden" id="listingId" value="0">
                    <input type="hidden" id="imageUrl" value="">
                    
                    <!-- Image Upload Section -->
                    <div class="mb-4">
                        <label class="form-label">Product Photo *</label>
                        <div class="image-upload-container" id="imageUploadContainer">
                            <div class="image-preview-area" id="imagePreviewArea">
                                <img id="imagePreview" src="" alt="Preview" style="display: none;">
                                <div class="upload-placeholder" id="uploadPlaceholder">
                                    <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #9ca3af;"></i>
                                    <p class="mt-3 mb-2" style="font-weight: 600; color: #1a1a1a;">Click to upload or drag and drop</p>
                                    <p class="text-muted" style="font-size: 0.875rem;">PNG, JPG, GIF up to 10MB</p>
                                </div>
                            </div>
                            <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                            <button type="button" class="btn-remove-image" id="removeImageBtn" style="display: none;" onclick="removeImage()">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                        <div class="mt-3">
                            <div class="d-flex align-items-center mb-2">
                                <hr class="flex-grow-1">
                                <span class="px-3 text-muted" style="font-size: 0.875rem;">or paste image URL</span>
                                <hr class="flex-grow-1">
                            </div>
                            <input type="url" class="form-control minimal-input" id="imageUrlInput" placeholder="https://example.com/image.jpg">
                        </div>
                    </div>

                    <!-- Title -->
                    <div class="mb-4">
                        <label for="title" class="form-label">Title *</label>
                        <input type="text" class="form-control minimal-input" name="title" id="title" placeholder="e.g., iPhone 13 Pro Max 256GB" required maxlength="100">
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <label for="description" class="form-label">Description *</label>
                        <textarea class="form-control minimal-input" name="description" id="description" rows="3" placeholder="Describe your item..." required maxlength="500"></textarea>
                    </div>

                    <div class="row g-3">
                        <!-- Price -->
                        <div class="col-md-6">
                            <label for="price" class="form-label">Price (‚Ç±) *</label>
                            <input type="number" class="form-control minimal-input" name="price" id="price" placeholder="0.00" step="0.01" min="0" required>
                        </div>

                        <!-- Category -->
                        <div class="col-md-6">
                            <label for="category" class="form-label">Category *</label>
                            <select class="form-select minimal-input" name="category" id="category" required>
                                <option value="">Select category</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Fashion">Fashion</option>
                                <option value="Home & Living">Home & Living</option>
                                <option value="Books">Books</option>
                                <option value="Sports">Sports</option>
                                <option value="Toys & Games">Toys & Games</option>
                                <option value="Vehicles">Vehicles</option>
                                <option value="Beauty">Beauty</option>
                            </select>
                        </div>
                    </div>

                    <!-- Condition -->
                    <div class="mt-4">
                        <label class="form-label">Condition *</label>
                        <div class="condition-options">
                            <input type="radio" class="btn-check" name="condition" id="conditionNew" value="New">
                            <label class="condition-option" for="conditionNew">New</label>

                            <input type="radio" class="btn-check" name="condition" id="conditionLikeNew" value="Like New">
                            <label class="condition-option" for="conditionLikeNew">Like New</label>

                            <input type="radio" class="btn-check" name="condition" id="conditionGood" value="Good">
                            <label class="condition-option" for="conditionGood">Good</label>

                            <input type="radio" class="btn-check" name="condition" id="conditionFair" value="Fair">
                            <label class="condition-option" for="conditionFair">Fair</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-modal-save btn-save-listing" onclick="saveListing()">
                    <span id="saveButtonText">Add Listing</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11000">
    <div id="toastNotification" class="toast" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage"></div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

@section Scripts {
<script src="~/js/firebase-client.js?v=@DateTime.Now.Ticks" type="module"></script>
<script>
    // Immediate loading without waiting for Firebase
    let userListingsLoaded = false;
    let pendingSoldOutItem = null;
    let pendingDeleteItem = null;
    
    // Update profile details modal with username and address from Firebase
    async function updateProfileDetailsFromFirebase(){
        const section = document.querySelector('.profile-page');
        const currentUserId = section.getAttribute('data-user-id') || '';
        const currentUsername = section.getAttribute('data-user-name') || '';
        const titleEl = document.querySelector('#profileDetailsModal .modal-title');
        const locEl = document.getElementById('profileLocation');
        if (titleEl){ titleEl.textContent = 'About ' + (currentUsername || currentUserId); }
        try{
            let retries = 0; while (typeof window.firebaseGetUserProfile !== 'function' && retries < 30){ await new Promise(r=>setTimeout(r,100)); retries++; }
            if (typeof window.firebaseGetUserProfile === 'function'){
                const res = await window.firebaseGetUserProfile(currentUserId);
                if (res?.success && res.profile){
                    const uname = res.profile.username || res.profile.user_name || currentUsername || currentUserId;
                    if (titleEl){ titleEl.textContent = 'About ' + uname; }
                    const address = res.profile.address || res.profile.location || res.profile.city;
                    if (locEl && address){ locEl.textContent = address; }
                }
            }
        }catch(e){ console.warn('updateProfileDetailsFromFirebase failed', e); }
    }

    // Tab switching functionality
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.profile-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // Update tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabName + 'Content').classList.add('active');
        
        // Show/hide Add New Listing button (only show on Listings tab for sellers)
        const section = document.querySelector('.profile-page');
        const userType = section.getAttribute('data-user-type') || 'buyer';
        const addBtn = document.getElementById('addNewListingBtn');
        if (addBtn) {
            addBtn.style.display = (tabName === 'listings' && userType.toLowerCase() !== 'buyer') ? 'block' : 'none';
        }
        
        // Load content based on tab
        if (tabName === 'history') {
            loadHistoryTab();
        } else if (tabName === 'listings') {
            // Reload listings content when switching to Listings tab
            if (userType.toLowerCase() === 'buyer') {
                loadSavedItemsForBuyer();
            } else {
                loadUserListings();
            }
        } else if (tabName === 'review') {
            loadReviewsTab();
        }
    }
    
    // Load reviews tab (for sellers to see reviews they received)
    async function loadReviewsTab() {
        const reviewsContainer = document.getElementById('reviewsContainer');
        const section = document.querySelector('.profile-page');
        const userId = section.getAttribute('data-user-id') || '';
        const userType = section.getAttribute('data-user-type') || 'buyer';
        
        if (!userId) {
            reviewsContainer.innerHTML = `
                <div class="empty-tab-state">
                    <i class="bi bi-star" style="font-size: 4rem; color: #ccc;"></i>
                    <h3>Reviews</h3>
                    <p>Please log in to view reviews</p>
                </div>
            `;
            return;
        }
        
        // Show loading
        reviewsContainer.innerHTML = `
            <div class="loading-state">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading reviews...</p>
            </div>
        `;
        
        try {
            // For sellers, show reviews they received
            if (userType.toLowerCase() === 'seller' || userType.toLowerCase() === 'admin') {
                if (typeof window.firebaseGetSellerReviews === 'function') {
                    const result = await window.firebaseGetSellerReviews(userId);
                    
                    if (result.success && result.reviews && result.reviews.length > 0) {
                        displaySellerReviews(result.reviews);
                    } else {
                        reviewsContainer.innerHTML = `
                            <div class="empty-tab-state">
                                <i class="bi bi-star" style="font-size: 4rem; color: #ccc;"></i>
                                <h3>No Reviews Yet</h3>
                                <p>You haven't received any reviews yet</p>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('Review function not available');
                }
            } else {
                // For buyers, show empty state (buyers write reviews, don't receive them)
                reviewsContainer.innerHTML = `
                    <div class="empty-tab-state">
                        <i class="bi bi-star" style="font-size: 4rem; color: #ccc;"></i>
                        <h3>Your Reviews</h3>
                        <p>Reviews you write for sellers will appear here</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading reviews:', error);
            reviewsContainer.innerHTML = `
                <div class="empty-tab-state">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #dc3545;"></i>
                    <h3>Error Loading Reviews</h3>
                    <p>${error.message || 'Please try again later'}</p>
                </div>
            `;
        }
    }
    
    function displaySellerReviews(reviews) {
        const reviewsContainer = document.getElementById('reviewsContainer');
        reviewsContainer.innerHTML = '<div class="reviews-list"></div>';
        const reviewsList = reviewsContainer.querySelector('.reviews-list');
        
        reviews.forEach(review => {
            const reviewCard = createReviewCardForProfile(review);
            reviewsList.appendChild(reviewCard);
        });
    }
    
    function createReviewCardForProfile(review) {
        const card = document.createElement('div');
        card.className = 'review-card';
        
        const buyerInitial = review.buyer_name ? review.buyer_name.charAt(0).toUpperCase() : 'U';
        const createdDate = review.created_at ? new Date(review.created_at.seconds * 1000).toLocaleDateString() : 'Recently';
        
        // Create stars
        let starsHTML = '';
        for (let i = 0; i < 5; i++) {
            if (i < review.rating) {
                starsHTML += '<i class="bi bi-star-fill" style="color: #fbbf24;"></i>';
            } else {
                starsHTML += '<i class="bi bi-star" style="color: #d1d5db;"></i>';
            }
        }
        
        // Build media gallery (images + optional single legacy image + optional video)
        let galleryHtml = '';
        if (review.images && Array.isArray(review.images) && review.images.length > 0) {
            const thumbs = review.images.map(u => `<div class=\"review-thumb\"><img src=\"${u}\" alt=\"Review image\" onerror=\"this.style.display='none'\" /></div>`).join('');
            galleryHtml = `<div class=\"review-gallery mt-2\">${thumbs}</div>`;
        } else if (review.image) {
            galleryHtml = `<div class=\"mt-2\"><img src=\"${review.image}\" alt=\"Review image\" style=\"max-width:100%; border-radius:8px;\" onerror=\"this.style.display='none'\" /></div>`;
        }
        const videoHtml = review.video ? `<div class=\"mt-2\"><video controls style=\"max-width:100%; border-radius:8px;\" src=\"${review.video}\" onerror=\"this.style.display='none'\"></video></div>` : '';
        
        card.innerHTML = `
            <div class="review-header">
                <div class="review-user-info">
                    <div class="review-avatar">${buyerInitial}</div>
                    <div class="review-user-details">
                        <h5 class="review-user-name">${review.buyer_name || 'Anonymous'}</h5>
                        <p class="review-username">@@${review.buyer_username || 'user'}</p>
                    </div>
                </div>
            </div>
            <div class="review-rating">
                ${starsHTML}
                <span class="review-date">${createdDate}</span>
            </div>
            <div class="review-comment">
                ${review.comment || '<em>No comment</em>'}
            </div>
            ${galleryHtml}
            ${videoHtml}
        `;
        
        return card;
    }
    
    // Load sold items for History tab
    async function loadHistoryTab() {
        const historyContent = document.getElementById('historyContent');
        const section = document.querySelector('.profile-page');
        const userId = section.getAttribute('data-user-id') || '';
        
        if (!userId) {
            historyContent.innerHTML = `
                <div class="empty-tab-state">
                    <i class="bi bi-clock-history" style="font-size: 4rem; color: #ccc;"></i>
                    <h3>Purchase History</h3>
                    <p>Please log in to view your history</p>
                </div>
            `;
            return;
        }
        
        // Show loading
        historyContent.innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading sold items...</p>
            </div>
        `;
        
        try {
            if (typeof window.firebaseFetchSoldItems === 'function') {
                const result = await window.firebaseFetchSoldItems(userId);
                
                if (result.success && result.items && result.items.length > 0) {
                    // Display sold items
                    const html = `
                        <div class="listings-grid">
                            ${result.items.map(item => `
                                <div class="listing-card-minimal sold-item">
                                    <div class="product-image-wrapper">
                                        <img src="${item.imageUrl || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop'}" 
                                             alt="${item.title || 'Product'}" 
                                             class="product-image"
                                             onerror="this.src='https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop'">
                                        <span class="sold-badge">SOLD OUT</span>
                                    </div>
                                    <div class="product-info">
                                        <h3 class="product-title">${item.title || 'Untitled'}</h3>
                                        <p class="product-description">${(item.description || '').substring(0, 80)}${(item.description || '').length > 80 ? '...' : ''}</p>
                                        <div class="product-meta">
                                            <span class="product-price">${window.formatCurrency(item.price || 0)}</span>
                                            <span class="product-category">${item.category || 'Uncategorized'}</span>
                                        </div>
                                        <small class="text-muted">Sold: ${item.sold_date ? new Date(item.sold_date.seconds * 1000).toLocaleDateString() : 'Recently'}</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    historyContent.innerHTML = html;
                } else {
                    historyContent.innerHTML = `
                        <div class="empty-tab-state">
                            <i class="bi bi-clock-history" style="font-size: 4rem; color: #ccc;"></i>
                            <h3>No Sold Items</h3>
                            <p>Items you mark as sold will appear here</p>
                        </div>
                    `;
                }
            } else {
                throw new Error('History feature not available');
            }
        } catch (error) {
            console.error('Error loading history:', error);
            historyContent.innerHTML = `
                <div class="empty-tab-state">
                    <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #dc3545;"></i>
                    <h3>Error Loading History</h3>
                    <p>${error.message || 'Please try again later'}</p>
                </div>
            `;
        }
    }
    
    // Profile details modal open
    document.addEventListener('DOMContentLoaded', function() {
        const link = document.getElementById('profileDetailsLink');
        if (link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('profileDetailsModal'));
                modal.show();
                updateProfileDetailsFromFirebase();
            });
        }
    });
    
    async function loadUserListings() {
        const container = document.getElementById('listingsContainer');
        console.log('üöÄ loadUserListings called');
        
        // Go directly to Firebase (skip server API)
        try {
            await loadFromFirebase(container);
        } catch (error) {
            console.error('Firebase loading failed:', error);
            showError(container, error.message);
        }
    }
    
    async function loadFromFirebase(container) {
        // Get user info from page data attributes
        const section = document.querySelector('.profile-page');
        var username = section.getAttribute('data-user-name') || '';
        var fullName = section.getAttribute('data-user-fullname') || '';
        var userId = section.getAttribute('data-user-id') || '';
        var userType = section.getAttribute('data-user-type') || 'seller';
        
        console.log('üîÑ [PROFILE] loadFromFirebase START');
        console.log('üîÑ [PROFILE] Current logged-in userId:', userId);
        console.log('üîÑ [PROFILE] Username:', username);

        sessionStorage.setItem('Username', username);
        sessionStorage.setItem('FullName', fullName);
        sessionStorage.setItem('UserId', userId);
        sessionStorage.setItem('UserType', userType);

        // Wait for Firebase to be ready
        let retries = 0;
        while (typeof window.firebaseFetchUserProducts !== 'function' && retries < 30) {
            await new Promise(r => setTimeout(r, 100));
            retries++;
        }
        console.log('üîÑ [PROFILE] Firebase ready after', retries, 'retries');

        if (typeof window.firebaseFetchUserProducts === 'function') {
            try {
                console.log('üîÑ [PROFILE] Calling firebaseFetchUserProducts for userId:', userId);
                // Use optimized function to fetch only this user's products (excludes sold items)
                const result = await window.firebaseFetchUserProducts(userId, false);
                console.log('üü¢ [PROFILE] firebaseFetchUserProducts result:', result);
                
                if (result.success && result.products) {
                    console.log('üü¢ [PROFILE] SUCCESS: Got', result.products.length, 'products for current user');
                    
                    if (result.products.length > 0) {
                        console.log('‚úÖ [PROFILE] Displaying', result.products.length, 'listings');
                        displayListings(result.products, container);
                        return;
                    } else {
                        console.log('‚ö†Ô∏è [PROFILE] No products found for user');
                    }
                } else {
                    console.log('‚ùå [PROFILE] result.success:', result.success, '| products:', result.products);
                }
            } catch (err) {
                console.error('‚ùå [PROFILE] Firebase fetch error:', err);
            }
        } else {
            console.error('‚ùå [PROFILE] firebaseFetchUserProducts not available');
        }

        // If Firebase didn't load, show empty state
        console.log('üìå [PROFILE] Showing empty state');
        showNoListings(container);
    }    function displayListings(listings, container) {
        if (!listings || listings.length === 0) {
            showNoListings(container);
            return;
        }
        
        const grid = document.createElement('div');
        grid.className = 'listings-grid';
        
        const userTypeAttr = document.querySelector('.profile-page').getAttribute('data-user-type');
        
        listings.forEach(listing => {
            const card = document.createElement('div');
            card.className = 'listing-card-minimal';
            card.id = `listing-${listing.id || listing.Id}`;
            
            const imageUrl = listing.imageUrl || listing.ImageUrl || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop';
            const price = listing.price || listing.Price || 0;
            const title = listing.title || listing.Title || 'Untitled';
            const description = listing.description || listing.Description || '';
            const condition = listing.condition || listing.Condition || 'New';
            const category = listing.category || listing.Category || 'Uncategorized';
            const listingId = listing.id || listing.Id;
            
            card.innerHTML = `
                <div class="product-image-wrapper">
                    <img src="${imageUrl}" alt="${title}" class="product-image" 
                         onerror="this.src='https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop'">
                    <span class="condition-badge badge-${condition.toLowerCase().replace(' ', '-')}">${condition}</span>
                </div>
                <div class="product-info">
                    <h3 class="product-title">${title}</h3>
                    <p class="product-description">${description}</p>
                    <div class="product-meta">
                        <span class="product-price">${window.formatCurrency(parseFloat(price))}</span>
                        <span class="product-category">${category}</span>
                    </div>
                    <div class="product-actions">
                        ${userTypeAttr === 'seller' || userTypeAttr === 'admin' ? `
                            <button class="btn-action btn-edit-minimal" onclick="editListing('${listingId}')" title="Edit listing">
                                <i class="bi bi-pencil"></i>
                                <span>Edit</span>
                            </button>
                            <button class="btn-action btn-soldout-minimal" onclick="markAsSoldOut('${listingId}', '${title.replace(/'/g, "\\'")}')">
                                <i class="bi bi-check-circle-fill"></i>
                                <span>Sold</span>
                            </button>
                            <button class="btn-action btn-delete-minimal" onclick="deleteListing('${listingId}', '${title.replace(/'/g, "\\'")}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        ` : `
                            <button class="btn-action btn-buy-minimal" onclick="viewListing('${listingId}')" style="background:#10b981;color:#fff;">
                                <i class="bi bi-bag-check"></i>
                                View
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            grid.appendChild(card);
        });
        
        container.innerHTML = '';
        container.appendChild(grid);
    }
    
    function showNoListings(container) {
        container.innerHTML = `
            <div class="empty-state-minimal" style="grid-column: 1 / -1;">
                <i class="bi bi-box-seam"></i>
                <h3>No listings yet</h3>
                <p>Start selling by creating your first listing</p>
                ${sessionStorage.getItem('UserType') === 'seller' || sessionStorage.getItem('UserType') === 'admin' ? 
                    '<button class="btn-add-new" onclick="openListingModal()"><i class="bi bi-plus-circle me-2"></i>Add New Listing</button>' : ''}
            </div>
        `;
    }
    
    function showNoAuth(container) {
        container.innerHTML = `
            <div class="no-listings">
                <i class="bi bi-box-seam"></i>
                <h4>Please log in to view your listings</h4>
                <a href="@Url.Action("Login", "Home")" class="btn btn-primary mt-3">Login</a>
            </div>
        `;
    }
    
    function showError(container, message) {
        container.innerHTML = `
            <div class="no-listings">
                <i class="bi bi-exclamation-triangle"></i>
                <h4>Error loading listings</h4>
                <p>${message || 'Please try again later'}</p>
                <button class="btn btn-primary mt-3" onclick="location.reload()">Retry</button>
            </div>
        `;
    }
    
    function viewListing(id) {
        if (!id) return;
        window.location.href = `/Home/ProductDetail?id=${id}`;
    }
    
    window.viewListing = viewListing;
    
    function shareProfile() {
        const url = window.location.href;
        if (navigator.share) {
            navigator.share({
                title: 'My Profile',
                url: url
            }).catch(err => log('Error sharing:', err));
        } else {
            navigator.clipboard.writeText(url).then(() => {
                alert('Profile link copied to clipboard!');
            });
        }
    }
    
    // Note: markAsSoldOut will be overridden at the END after all scripts load
    
    // Handle sold out confirmation - setup immediately
    (function setupConfirmButtons() {
        const confirmSoldBtn = document.getElementById('confirmSoldBtn');
        if (confirmSoldBtn) {
            confirmSoldBtn.addEventListener('click', async function() {
                if (!pendingSoldOutItem) return;
                
                const { productId, title } = pendingSoldOutItem;
                
                // Close modal
                const soldModal = bootstrap.Modal.getInstance(document.getElementById('soldOutModal'));
                soldModal.hide();
                
                try {
                    console.log('üîÑ Marking product as sold:', productId);
                    
                    // Call Firebase function to update status
                    if (typeof window.firebaseMarkAsSold === 'function') {
                        console.log('‚úÖ Calling firebaseMarkAsSold...');
                        const result = await window.firebaseMarkAsSold(productId);
                        console.log('üìä Result:', result);
                        
                        if (result.success) {
                            console.log('‚úÖ Product marked as sold successfully');
                            
                            // Show success message
                            const toastEl = document.getElementById('toastNotification');
                            const toastMsg = document.getElementById('toastMessage');
                            if (toastEl && toastMsg) {
                                toastMsg.textContent = '‚úì Item marked as sold and moved to history';
                                const toast = new bootstrap.Toast(toastEl);
                                toast.show();
                            }
                            
                            // Reload listings to reflect changes
                            setTimeout(() => {
                                loadUserListings();
                            }, 500);
                        } else {
                            console.error('‚ùå Failed to mark as sold:', result.message);
                            alert('Failed to mark item as sold: ' + (result.message || 'Unknown error'));
                        }
                    } else {
                        console.error('‚ùå firebaseMarkAsSold function not available');
                        alert('Sold out feature not available. Please refresh the page.');
                    }
                } catch (error) {
                    console.error('‚ùå Error marking as sold:', error);
                    alert('Error: ' + error.message);
                }
                
                pendingSoldOutItem = null;
            });
        } else {
            console.error('‚ùå confirmSoldBtn not found!');
        }
        
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', async function() {
                if (!pendingDeleteItem) return;
                
                const { productId, title } = pendingDeleteItem;
                
                // Close modal
                const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                deleteModal.hide();
                
                try {
                    console.log('üóëÔ∏è Deleting product:', productId);
                    
                    // Call Firebase function to delete
                    if (typeof window.firebaseDeleteListing === 'function') {
                        const result = await window.firebaseDeleteListing(productId);
                        
                        if (result.success) {
                            console.log('‚úÖ Product deleted successfully');
                            
                            // Show success message
                            const toastEl = document.getElementById('toastNotification');
                            const toastMsg = document.getElementById('toastMessage');
                            if (toastEl && toastMsg) {
                                toastMsg.textContent = '‚úì Listing deleted successfully';
                                const toast = new bootstrap.Toast(toastEl);
                                toast.show();
                            }
                            
                            // Reload listings
                            setTimeout(() => {
                                loadUserListings();
                            }, 500);
                        } else {
                            alert('Failed to delete listing: ' + (result.message || 'Unknown error'));
                        }
                    } else {
                        alert('Delete feature not available. Please refresh the page.');
                    }
                } catch (error) {
                    console.error('‚ùå Error deleting:', error);
                    alert('Error: ' + error.message);
                }
                
                pendingDeleteItem = null;
            });
        } else {
            console.error('‚ùå confirmDeleteBtn not found!');
        }
    })();
    
    // Note: deleteListing will be overridden at the END after all scripts load
    
    // Load saved items for buyers
    async function loadSavedItems() {
        const container = document.getElementById('savedItemsContainer');
        const section = document.querySelector('.profile-page');
        const userId = section.getAttribute('data-user-id') || '';
        
        console.log('üîñ Loading saved items for buyer:', userId);
        
        // Wait for Firebase to be ready
        let retries = 0;
        while (typeof window.firebaseGetSavedProducts !== 'function' && retries < 30) {
            await new Promise(r => setTimeout(r, 100));
            retries++;
        }
        
        try {
            if (typeof window.firebaseGetSavedProducts === 'function') {
                const result = await window.firebaseGetSavedProducts(userId);
                
                if (result.success && result.products && result.products.length > 0) {
                    console.log('‚úÖ Loaded', result.products.length, 'saved items');
                    displaySavedItems(result.products, container);
                } else {
                    container.innerHTML = `
                        <div class="empty-state-minimal" style="grid-column: 1 / -1;">
                            <i class="bi bi-heart"></i>
                            <h3>No Saved Items</h3>
                            <p>Items you save will appear here</p>
                        </div>
                    `;
                }
            }
        } catch (error) {
            console.error('Error loading saved items:', error);
            container.innerHTML = `
                <div class="empty-state-minimal" style="grid-column: 1 / -1;">
                    <i class="bi bi-exclamation-triangle"></i>
                    <h3>Error Loading Saved Items</h3>
                    <p>${error.message || 'Please try again later'}</p>
                </div>
            `;
        }
    }
    
    function displaySavedItems(items, container) {
        const grid = document.createElement('div');
        grid.className = 'listings-grid';
        
        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'listing-card-minimal';
            
            card.innerHTML = `
                <div class="product-image-wrapper">
                    <img src="${item.imageUrl || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop'}" 
                         alt="${item.title}" 
                         class="product-image" 
                         onerror="this.src='https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop'">
                    <span class="condition-badge badge-${(item.condition || 'new').toLowerCase().replace(' ', '-')}">${item.condition || 'New'}</span>
                </div>
                <div class="product-info">
                    <h3 class="product-title">${item.title || 'Untitled'}</h3>
                    <p class="product-description">${(item.description || '').substring(0, 80)}${(item.description || '').length > 80 ? '...' : ''}</p>
                    <div class="product-meta">
                        <span class="product-price">${window.formatCurrency(item.price || 0)}</span>
                        <span class="product-category">${item.category || 'Uncategorized'}</span>
                    </div>
                    <div class="product-seller-info">
                        <span class="seller-name-small"><i class="bi bi-person"></i> ${item.sellerName || 'Unknown Seller'}</span>
                    </div>
                    <div class="product-actions">
                        <button class="btn-action btn-view-minimal" onclick="viewProduct('${item.product_id || item.productId}')}" style="background:#0ea5e9;color:#fff;">
                            <i class="bi bi-eye"></i>
                            <span>View</span>
                        </button>
                        <button class="btn-action btn-unsave-minimal" onclick="unsaveSavedItem('${item.product_id || item.productId}')}" style="background:#ef4444;color:#fff;">
                            <i class="bi bi-heart-fill"></i>
                            <span>Unsave</span>
                        </button>
                    </div>
                </div>
            `;
            
            grid.appendChild(card);
        });
        
        container.innerHTML = '';
        container.appendChild(grid);
    }
    
    async function unsaveSavedItem(productId) {
        const section = document.querySelector('.profile-page');
        const userId = section.getAttribute('data-user-id');
        const userType = section.getAttribute('data-user-type') || 'buyer';
        
        if (!confirm('Remove this item from your saved items?')) return;
        
        try {
            if (typeof window.firebaseUnsaveProduct === 'function') {
                const result = await window.firebaseUnsaveProduct(userId, productId);
                if (result.success) {
                    console.log('‚úÖ Item unsaved');
                    // Reload appropriate content based on user type
                    if (userType.toLowerCase() === 'buyer') {
                        loadSavedItemsForBuyer();
                    } else {
                        loadSavedItems();
                    }
                }
            }
        } catch (error) {
            console.error('Error unsaving item:', error);
            alert('Error removing item. Please try again.');
        }
    }
    
    function viewProduct(productId) {
        // Navigate to product detail or open modal
        window.location.href = `/Home/Browse?productId=${productId}`;
    }
    
    window.unsaveSavedItem = unsaveSavedItem;
    window.viewProduct = viewProduct;

    // Wait for Firebase functions to be available
    function waitForFirebaseFunctions() {
        console.log('‚è≥ Checking Firebase readiness...');
        const section = document.querySelector('.profile-page');
        const userType = section.getAttribute('data-user-type') || 'buyer';
        
        if (typeof window.firebaseFetchAllProducts === 'function' && typeof window.firebaseCreateListing === 'function') {
            console.log('‚úÖ Firebase functions ready');
            
            // Load appropriate content based on user type
            if (userType.toLowerCase() === 'buyer') {
                // For buyers, load saved items in Listings tab
                loadSavedItemsForBuyer();
            } else {
                // For sellers, load their own products
                loadUserListings();
            }
        } else {
            console.log('‚è≥ Waiting for Firebase:', {
                'firebaseFetchAllProducts': typeof window.firebaseFetchAllProducts,
                'firebaseCreateListing': typeof window.firebaseCreateListing
            });
            setTimeout(waitForFirebaseFunctions, 100);
        }
    }
    
    // Load saved items for buyer in Listings tab
    async function loadSavedItemsForBuyer() {
        const container = document.getElementById('listingsContainer');
        const section = document.querySelector('.profile-page');
        const userId = section.getAttribute('data-user-id') || '';
        
        console.log('üîñ Loading saved items for buyer in Listings tab:', userId);
        
        // Wait for Firebase to be ready
        let retries = 0;
        while (typeof window.firebaseGetSavedProducts !== 'function' && retries < 30) {
            await new Promise(r => setTimeout(r, 100));
            retries++;
        }
        
        try {
            if (typeof window.firebaseGetSavedProducts === 'function') {
                const result = await window.firebaseGetSavedProducts(userId);
                
                if (result.success && result.products && result.products.length > 0) {
                    console.log('‚úÖ Loaded', result.products.length, 'saved items');
                    displaySavedItemsAsBuyerListings(result.products, container);
                } else {
                    container.innerHTML = `
                        <div class="empty-state-minimal" style="grid-column: 1 / -1;">
                            <i class="bi bi-heart"></i>
                            <h3>No Saved Items</h3>
                            <p>Items you save will appear here</p>
                        </div>
                    `;
                }
            }
        } catch (error) {
            console.error('Error loading saved items:', error);
            container.innerHTML = `
                <div class="empty-state-minimal" style="grid-column: 1 / -1;">
                    <i class="bi bi-exclamation-triangle"></i>
                    <h3>Error Loading Saved Items</h3>
                    <p>${error.message || 'Please try again later'}</p>
                </div>
            `;
        }
    }
    
    function displaySavedItemsAsBuyerListings(items, container) {
        const grid = document.createElement('div');
        grid.className = 'listings-grid';
        
        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'listing-card-minimal';
            
            card.innerHTML = `
                <div class="product-image-wrapper">
                    <img src="${item.imageUrl || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop'}" 
                         alt="${item.title}" 
                         class="product-image" 
                         onerror="this.src='https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop'">
                    <span class="condition-badge badge-${(item.condition || 'new').toLowerCase().replace(' ', '-')}">${item.condition || 'New'}</span>
                </div>
                <div class="product-info">
                    <h3 class="product-title">${item.title || 'Untitled'}</h3>
                    <p class="product-description">${(item.description || '').substring(0, 80)}${(item.description || '').length > 80 ? '...' : ''}</p>
                    <div class="product-meta">
                        <span class="product-price">${window.formatCurrency(item.price || 0)}</span>
                        <span class="product-category">${item.category || 'Uncategorized'}</span>
                    </div>
                    <div class="product-seller-info">
                        <span class="seller-name-small"><i class="bi bi-person"></i> ${item.sellerName || 'Unknown Seller'}</span>
                    </div>
                    <div class="product-actions">
                        <button class="btn-action btn-view-minimal" onclick="viewProduct('${item.product_id || item.productId}')}" style="background:#0ea5e9;color:#fff;">
                            <i class="bi bi-eye"></i>
                            <span>View</span>
                        </button>
                        <button class="btn-action btn-unsave-minimal" onclick="unsaveSavedItem('${item.product_id || item.productId}')}" style="background:#ef4444;color:#fff;">
                            <i class="bi bi-heart-fill"></i>
                            <span>Unsave</span>
                        </button>
                    </div>
                </div>
            `;
            
            grid.appendChild(card);
        });
        
        container.innerHTML = '';
        container.appendChild(grid);
    }
    
    // Review media viewer
    function openReviewMediaViewer(type, src) {
        const backdrop = document.getElementById('reviewLightboxBackdrop');
        const box = document.getElementById('reviewLightbox');
        if (!backdrop || !box) return;
        // clear previous content except close button
        Array.from(box.children).forEach(ch => { if (ch.id !== 'lightboxCloseBtn') ch.remove(); });
        let el;
        if (type === 'image') {
            el = document.createElement('img');
            el.src = src;
            el.alt = 'Review image';
            el.onerror = () => { el.style.display = 'none'; };
        } else if (type === 'video') {
            el = document.createElement('video');
            el.src = src;
            el.controls = true;
            el.autoplay = true;
            el.onerror = () => { el.style.display = 'none'; };
        }
        if (el) box.appendChild(el);
        backdrop.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    function closeReviewMediaViewer() {
        const backdrop = document.getElementById('reviewLightboxBackdrop');
        const box = document.getElementById('reviewLightbox');
        if (!backdrop || !box) return;
        backdrop.style.display = 'none';
        // stop video if present
        const vid = box.querySelector('video'); if (vid) { vid.pause(); vid.src = ''; }
        document.body.style.overflow = '';
    }
    window.openReviewMediaViewer = openReviewMediaViewer;
    window.closeReviewMediaViewer = closeReviewMediaViewer;
    document.getElementById('lightboxCloseBtn')?.addEventListener('click', closeReviewMediaViewer);
    document.getElementById('reviewLightboxBackdrop')?.addEventListener('click', (e)=>{ if (e.target.id === 'reviewLightboxBackdrop') closeReviewMediaViewer(); });

    // Enhance review cards to open viewer on click
    function enableReviewMediaClicks(root) {
        const container = root || document;
        container.querySelectorAll('.review-gallery .review-thumb img').forEach(img => {
            img.style.cursor = 'zoom-in';
            img.addEventListener('click', () => openReviewMediaViewer('image', img.src));
        });
        container.querySelectorAll('.reviews-container video, .review-card video').forEach(video => {
            video.style.cursor = 'pointer';
            video.addEventListener('click', () => openReviewMediaViewer('video', video.currentSrc || video.src));
        });
    }
    // Call after reviews load
    const origDisplaySellerReviews = window.displaySellerReviews;
    window.displaySellerReviews = function(reviews){
        if (origDisplaySellerReviews) origDisplaySellerReviews(reviews);
        enableReviewMediaClicks(document.getElementById('reviewsContainer'));
    };
    // Also enable on DOM ready in case of pre-rendered
    document.addEventListener('DOMContentLoaded', () => enableReviewMediaClicks());
</script>
<script src="~/js/listings-manager.js?v=@DateTime.Now.Ticks"></script>
<script src="~/js/listings-enhanced.js?v=@DateTime.Now.Ticks"></script>
<script>
    // OVERRIDE FUNCTIONS AFTER ALL SCRIPTS LOAD - This ensures our modal functions are FINAL
    console.log('üîß Installing modal overrides AFTER external scripts...');
    
    // Re-override markAsSoldOut to use modal (FINAL VERSION)
    window.markAsSoldOut = function(productId, title) {
        console.log('üéØ‚úÖ MODAL markAsSoldOut (FINAL) called with:', productId, title);
        
        pendingSoldOutItem = { productId, title };
        document.getElementById('soldOutItemTitle').textContent = title;
        const soldModal = new bootstrap.Modal(document.getElementById('soldOutModal'));
        soldModal.show();
    };
    
    // Re-override deleteListing to use modal (FINAL VERSION)
    window.deleteListing = function(productId, title) {
        console.log('üéØ‚úÖ MODAL deleteListing (FINAL) called with:', productId, title);
        
        pendingDeleteItem = { productId, title };
        document.getElementById('deleteItemTitle').textContent = title;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    };
    
    console.log('‚úÖ Modal overrides installed successfully!');
</script>
}



