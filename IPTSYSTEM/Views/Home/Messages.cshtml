@model List<IPTSYSTEM.Models.Conversation>
@{
    ViewData["Title"] = "Messages";
    var currentUserId = Context.Session.GetString("UserId") ?? "";
    var currentUserName = Context.Session.GetString("FullName") ?? Context.Session.GetString("Username") ?? "";
    var conversationIdParam = Context.Request.Query["conversationId"].ToString();
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/messages.css" asp-append-version="true" />
}

<!-- Messages Page -->
<section class="messages-page">
    <div class="container-fluid py-4">
        <!-- Page Header -->
 <div class="mb-4">
       <h1 class="messages-page-title mb-1">Messages</h1>
       <p class="messages-page-subtitle text-muted mb-0">Chat with buyers and sellers</p>
      </div>

     <!-- Messages Container -->
    <div class="messages-container">
      <!-- Left Panel: Conversations List -->
  <div class="conversations-panel">
       <!-- Search Box -->
  <div class="search-conversations">
       <i class="bi bi-search search-icon"></i>
             <input type="text" class="form-control" id="searchConversations" placeholder="Search conversations..." onkeyup="filterConversations()">
 </div>

      <!-- Conversation List -->
       <div class="conversation-list" id="conversationList">
            <!-- Conversations will be loaded dynamically from Firestore -->
            <div class="loading-conversations">
                <div class="spinner-border spinner-border-sm" role="status"></div>
                <span class="ms-2">Loading conversations...</span>
            </div>
       </div>
    </div>

       <!-- Right Panel: Chat View -->
        <div class="chat-panel">
          <!-- Chat Header -->
<div class="chat-header" id="chatHeader" style="display: none;">
             <div class="chat-user-info">
       <div class="chat-user-avatar">
      <img src="" alt="" id="chatAvatar">
      <span class="status-indicator" id="chatStatus"></span>
      </div>
       <div>
        <h3 class="chat-user-name" id="chatUserName"></h3>
      <p class="chat-user-status" id="chatUserStatus"></p>
         </div>
       </div>
 <button class="btn-chat-options" onclick="toggleChatOptions()">
     <i class="bi bi-three-dots-vertical"></i>
  </button>
  </div>

      <!-- Empty State -->
    <div class="chat-empty-state" id="chatEmptyState">
       <div class="empty-state-content">
       <i class="bi bi-chat-dots" style="font-size: 5rem; color: #d1d5db;"></i>
       <h3 class="mt-4 mb-2" style="color: #6b7280;">Select a conversation</h3>
     <p style="color: #9ca3af;">Choose a conversation from the list to start chatting</p>
         </div>
     </div>

     <!-- Chat Messages -->
          <div class="chat-messages" id="chatMessages" style="display: none;">
     <!-- Messages will be loaded here dynamically -->
 </div>

          <!-- Chat Input -->
        <div class="chat-input-container" id="chatInputContainer" style="display: none;">
 <input type="text" class="chat-input" id="messageInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
            <button class="btn-send-message" onclick="sendMessage()">
           <i class="bi bi-send-fill"></i>
      </button>
       </div>
     </div>
        </div>
    </div>
</section>

<!-- Chat Options Dropdown -->
<div class="chat-options-dropdown" id="chatOptionsDropdown" style="display: none;">
    <button onclick="blockUser()"><i class="bi bi-slash-circle me-2"></i>Block User</button>
    <button onclick="reportUser()"><i class="bi bi-flag me-2"></i>Report</button>
<button onclick="deleteChat()"><i class="bi bi-trash me-2"></i>Delete Chat</button>
</div>

<!-- Report User Modal -->
<div class="modal fade" id="reportUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.4); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
            <div class="modal-header border-0" style="padding: 1.5rem 1.5rem 0.5rem;">
                <h5 class="modal-title fw-bold" style="color: #1a1a2e; font-size: 1.5rem;">Report User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p class="text-muted mb-4">Please let us know your concern. This report will be sent directly to the administrators.</p>
                
                <form id="reportUserForm">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Reason for Report</label>
                        <select class="form-select" id="reportReason" required style="border-radius: 12px; padding: 0.75rem;">
                            <option value="" selected disabled>Select a reason...</option>
                            <option value="scam">Suspicious / Scam Activity</option>
                            <option value="harassment">Harassment / Abusive Language</option>
                            <option value="inappropriate">Inappropriate Content</option>
                            <option value="spam">Spamming</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Details</label>
                        <textarea class="form-control" id="reportDetails" rows="4" placeholder="Please describe what happened..." required style="border-radius: 12px; padding: 0.75rem; resize: none;"></textarea>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-danger btn-lg" style="border-radius: 12px; font-weight: 600;">
                            Submit Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11000">
    <div id="toastNotification" class="toast align-items-center border-0" role="alert">
        <div class="d-flex">
     <div class="toast-body" id="toastMessage"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
 </div>
    </div>
</div>

@section Scripts {
    <script>
        // Pass server-side values to JavaScript
        const currentUserId = '@currentUserId';
        const currentUserName = '@currentUserName';
        const initialConversationId = '@conversationIdParam';
    </script>
    <script src="~/js/firebase-client.js" type="module"></script>
    <script src="~/js/messages-manager.js"></script>
}

@functions {
    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;
        
        if (timeSpan.TotalMinutes < 1) return "Just now";
 if (timeSpan.TotalMinutes < 60) return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24) return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7) return $"{(int)timeSpan.TotalDays}d ago";
   
        return dateTime.ToString("MMM dd");
    }
}
