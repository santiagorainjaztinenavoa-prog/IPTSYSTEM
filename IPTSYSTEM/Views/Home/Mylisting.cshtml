@{
 ViewData["Title"] = "My Listings";
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/mylistings.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/listing-form.css" asp-append-version="true" />
}

<!-- My Listings Page - Modern Minimalist Design -->
<section class="my-listings-page" 
         data-user-name="@(Context.Session.GetString("Username") ?? "")"
         data-user-fullname="@(Context.Session.GetString("FullName") ?? "")"
         data-user-id="@(Context.Session.GetString("UserId") ?? "")"
         data-user-type="@(Context.Session.GetString("UserType") ?? "seller")">
  <div class="container py-5">
        <!-- Page Header - Clean & Simple -->
        <div class="page-header mb-5">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-4">
                    <div>
                        <h1 class="page-title">My Listings</h1>
                        <p class="page-subtitle">Manage your products</p>
                    </div>
                </div>
                @if (Context.Session.GetString("UserType") == "seller" || Context.Session.GetString("UserType") == "admin")
                {
                    <button class="btn-add-new" onclick="openListingModal()">
                        <i class="bi bi-plus-circle me-2"></i>
                        Add New Listing
                    </button>
                }
            </div>
        </div>

        <!-- Listings Grid - Minimalist Cards -->
        <div class="listings-grid" id="listings-container">
            <!-- Loaded dynamically from Firebase -->
        </div>
    </div>
</section>

<!-- Add/Edit Listing Modal -->
<div class="modal fade" id="listingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content modern-modal">
            <div class="modal-header border-0">
                <div>
       <h2 class="modal-title" id="modalTitle">Add New Listing</h2>
    <p class="modal-subtitle">Fill in the details below</p>
   </div>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
         </div>
          <div class="modal-body">
   <form id="listingForm">
   <input type="hidden" id="listingId" value="0">
    <input type="hidden" id="imageUrl" value="">
    
       <!-- Image Upload Section -->
      <div class="mb-4">
      <label class="form-label">Product Photo *</label>
   
             <!-- Image Preview Box -->
       <div class="image-upload-container" id="imageUploadContainer">
   <div class="image-preview-area" id="imagePreviewArea">
                  <img id="imagePreview" src="" alt="Preview" style="display: none;">
       <div class="upload-placeholder" id="uploadPlaceholder">
    <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #9ca3af;"></i>
     <p class="mt-3 mb-2" style="font-weight: 600; color: #1a1a1a;">Click to upload or drag and drop</p>
  <p class="text-muted" style="font-size: 0.875rem;">PNG, JPG, GIF up to 10MB</p>
      </div>
     </div>
       
       <!-- Hidden File Input -->
         <input type="file" 
            id="imageFileInput" 
             accept="image/*" 
      style="display: none;">
     
          <!-- Remove Button -->
         <button type="button" 
      class="btn-remove-image" 
   id="removeImageBtn" 
                   style="display: none;"
     onclick="removeImage()">
    <i class="bi bi-x-circle"></i>
 </button>
    </div>
   
         <!-- Alternative: Paste URL -->
    <div class="mt-3">
                  <div class="d-flex align-items-center mb-2">
           <hr class="flex-grow-1">
           <span class="px-3 text-muted" style="font-size: 0.875rem;">or paste image URL</span>
        <hr class="flex-grow-1">
       </div>
                    <input type="url" 
        class="form-control minimal-input" 
          id="imageUrlInput" 
          placeholder="https://example.com/image.jpg">
         </div>
      </div>

  <!-- Title -->
    <div class="mb-4">
    <label for="title" class="form-label">Title *</label>
<input type="text" 
 class="form-control minimal-input" 
 name="title"
 id="title" 
 placeholder="e.g., iPhone 13 Pro Max 256GB" 
        required
       maxlength="100">
  </div>

       <!-- Description -->
     <div class="mb-4">
    <label for="description" class="form-label">Description *</label>
    <textarea class="form-control minimal-input" 
     name="description"
     id="description" 
          rows="3" 
         placeholder="Describe your item..." 
 required
    maxlength="500"></textarea>
     </div>

            <div class="row g-3">
          <!-- Price -->
 <div class="col-md-6">
      <label for="price" class="form-label">Price ($) *</label>
      <input type="number" 
 class="form-control minimal-input" 
 name="price"
    id="price" 
     placeholder="0.00" 
        step="0.01" 
     min="0" 
      required>
  </div>

<!-- Category -->
 <div class="col-md-6">
          <label for="category" class="form-label">Category *</label>
         <select class="form-select minimal-input" name="category" id="category" required>
    <option value="">Select category</option>
     <option value="Electronics">Electronics</option>
     <option value="Fashion">Fashion</option>
     <option value="Home & Living">Home & Living</option>
<option value="Books">Books</option>
       <option value="Sports">Sports</option>
  <option value="Furniture">Furniture</option>
      </select>
   </div>
</div>

 <!-- Condition -->
   <div class="mt-4">
     <label class="form-label">Condition *</label>
          <div class="condition-options">
             <input type="radio" class="btn-check" name="condition" id="conditionNew" value="New">
     <label class="condition-option" for="conditionNew">New</label>

       <input type="radio" class="btn-check" name="condition" id="conditionLikeNew" value="Like New">
       <label class="condition-option" for="conditionLikeNew">Like New</label>

       <input type="radio" class="btn-check" name="condition" id="conditionGood" value="Good">
  <label class="condition-option" for="conditionGood">Good</label>

      <input type="radio" class="btn-check" name="condition" id="conditionFair" value="Fair">
           <label class="condition-option" for="conditionFair">Fair</label>
         </div>
  </div>
  
    <!-- Hidden imageUrl field (already defined at top of form) -->
  </form>
   </div>
          <div class="modal-footer border-0">
         <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">Cancel</button>
    <button type="button" class="btn-modal-save btn-save-listing" onclick="saveListing()">
        <span id="saveButtonText">Add Listing</span>
    </button>
    </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11000">
    <div id="toastNotification" class="toast" role="alert">
<div class="d-flex">
    <div class="toast-body" id="toastMessage"></div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/firebase-client.js" type="module"></script>
    <script>
        // Wait for Firebase functions to be available
        function waitForFirebaseFunctions() {
            if (typeof window.firebaseCreateListing === 'function') {
                console.log('Firebase functions ready');
                // Get user info from page data attributes
                const section = document.querySelector('.my-listings-page');
                var username = section.getAttribute('data-user-name') || '';
                var fullName = section.getAttribute('data-user-fullname') || '';
                var userId = section.getAttribute('data-user-id') || '';
                var userType = section.getAttribute('data-user-type') || 'seller';
                
                // If UserId is empty, fallback to username
                if (!userId || userId === '') {
                    userId = username;
                    console.log('⚠️  UserId was empty, using username as fallback:', userId);
                }
                
                sessionStorage.setItem('Username', username);
                sessionStorage.setItem('FullName', fullName);
                sessionStorage.setItem('UserId', userId);
                sessionStorage.setItem('UserType', userType);
                
                console.log('Session data stored:', { username, fullName, userId, userType });
                
                // NOW load listings from Firebase
                if (typeof window.loadListingsFromFirebase === 'function') {
                    console.log('Loading listings from Firebase...');
                    window.loadListingsFromFirebase();
                }
            } else {
                setTimeout(waitForFirebaseFunctions, 100);
            }
        }
        waitForFirebaseFunctions();
    </script>
    <script src="~/js/listing-form.js"></script>
    <script src="~/js/listings-manager.js"></script>
    <script src="~/js/listings-enhanced.js"></script>
}
