<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Recommerce</title>
    <link rel="icon" type="image/png" href="/logo/logo.png" />
    <!-- Google Fonts - Inter for modern typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family:Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <script>
        // Global category -> icon helper
        window.categoryToIcon = function(category) {
            if (!category || typeof category !== 'string') return 'bi-tag';
            const c = category.trim().toLowerCase();
            switch(c) {
                case 'electronics': return 'bi-laptop';
                case 'fashion': return 'bi-bag';
                case 'home & living': return 'bi-house-door';
                case 'books': return 'bi-book';
                case 'sports': return 'bi-trophy';
                case 'toys & games': return 'bi-controller';
                case 'vehicles': return 'bi-truck';
                case 'furniture': return 'bi-truck';
                case 'beauty': return 'bi-stars';
                default: return 'bi-tag';
            }
        };
        window.normalizeCategoryName = function(category) {
            if (!category || typeof category !== 'string') return category;
            if (category.trim().toLowerCase() === 'furniture') return 'Vehicles';
            return category;
        };

        // Global currency formatter for Philippine Peso
        window.formatCurrency = function(value, options) {
            const num = Number(value);
            const safe = Number.isFinite(num) ? num : 0;
            try {
                return new Intl.NumberFormat(options?.locale || 'en-PH', {
                    style: 'currency',
                    currency: options?.currency || 'PHP',
                    minimumFractionDigits: options?.minimumFractionDigits ?? 2,
                    maximumFractionDigits: options?.maximumFractionDigits ?? 2
                }).format(safe);
            } catch (e) {
                // Fallback if Intl not available
                return 'â‚±' + safe.toFixed(options?.maximumFractionDigits ?? 2);
            }
        };
    </script>
    <link rel="stylesheet" href="~/IPTSYSTEM.styles.css" asp-append-version="true" />
    @await RenderSectionAsync("Styles", required: false)
</head>

<body>
    <header class="modern-header">
        <nav class="navbar fixed-top navbar-expand-lg">
            <div class="container-fluid px-4 py-2">
                <!-- Brand with Logo - Left Side -->
                <a class="navbar-brand brand-logo" asp-area="" asp-controller="Home" asp-action="Index">
                    <div class="logo-wrapper" style="width:80px; height:80px;">
                        <img src="/logo/logo.png" alt="System Logo" class="logo-icon" style="width:70px; height:70px;" />
                    </div>
                    <span class="brand-text" style="font-size:2.5rem;">Recommerce</span>
                </a>

                <!-- Mobile Toggle -->
                <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarContent">
                    <!-- Navigation Links - Centered -->
                    <ul class="navbar-nav nav-center mx-auto mb-0" style="position: absolute; left: 50%; transform: translateX(-50%);">
                        <li class="nav-item">
                            <a class="nav-link modern-nav-link @(ViewContext.RouteData.Values["action"]?.ToString() == "Index" ? "active" : "")" asp-area="" asp-controller="Home" asp-action="Index">
                                <span>Home</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link modern-nav-link @(ViewContext.RouteData.Values["action"]?.ToString() == "Categories" ? "active" : "")" asp-area="" asp-controller="Home" asp-action="Categories">
                                <span>Categories</span>
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link modern-nav-link @(ViewContext.RouteData.Values["action"]?.ToString() == "Browse" ? "active" : "")" asp-area="" asp-controller="Home" asp-action="Browse">
                                <span>Browse</span>
                            </a>
                        </li>
                    </ul>

                    <!-- Right Side - Icons only (search removed) -->
                    <div class="header-actions d-flex align-items-center gap-3 ms-auto">
                        <!-- Icon Actions -->
                        <div class="icon-actions d-flex align-items-center gap-2">
                            @* Saved Products icon for both user types *@
                            @if (Context.Session.GetString("Username") != null)
                            {
                                var userType = Context.Session.GetString("UserType");
                                if (userType == "buyer")
                                {
                                    <a href="#" class="action-icon saved-icon" title="Saved Products" onclick="openSavedProductsModal(); return false;">
                                        <i class="bi bi-heart-fill"></i>
                                        <span class="icon-badge" style="display: none;">0</span>
                                    </a>
                                }
                                else if (userType == "seller")
                                {
                                    <a href="#" class="action-icon saved-icon" title="Saved Products" onclick="openSavedProductsModal(); return false;">
                                        <i class="bi bi-heart-fill"></i>
                                        <span class="icon-badge" style="display: none;">0</span>
                                    </a>
                                }
                                
                                @* Messages icon button placed beside heart *@
                                <a class="action-icon messages-icon" href="@Url.Action("Messages","Home")" title="Messages" style="position:relative; display:inline-flex; align-items:center;">
                                    <img src="/images/messages.png" alt="Messages" style="width:24px;height:24px;object-fit:contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';" />
                                    <i class="bi bi-chat-dots" style="display:none; font-size:1.2rem;"></i>
                                    <span class="messages-badge" style="display:none; position:absolute; top:-6px; right:-6px; background:#ef4444; color:#fff; font-size:10px; padding:2px 6px; border-radius:10px; min-width:18px; text-align:center;">0</span>
                                </a>
                                <!-- Presentation Mode Toggle removed -->
                                
                                <!-- Logged In User with avatar and role -->
                                    var fullName = Context.Session.GetString("FullName") ?? string.Empty;
                                    var username = Context.Session.GetString("Username") ?? string.Empty;
                                    var navUserId = Context.Session.GetString("UserId") ?? string.Empty;
                                    var displayName = !string.IsNullOrWhiteSpace(fullName) ? fullName : username;
                                    var firstInitial = "?";
                                    if (!string.IsNullOrWhiteSpace(displayName))
                                    {
                                        var parts = displayName.Split(' ', System.StringSplitOptions.RemoveEmptyEntries);
                                        firstInitial = parts.Length > 0 && parts[0].Length > 0 ? parts[0].Substring(0, 1).ToUpper() : displayName.Substring(0, 1).ToUpper();
                                    }
                                    var userTypeStr = (Context.Session.GetString("UserType") ?? "buyer").ToLowerInvariant();
                                    var userTypeDisplay = char.ToUpper(userTypeStr[0]) + (userTypeStr.Length > 1 ? userTypeStr.Substring(1) : string.Empty);

                                <div class="dropdown user-profile">
                                    <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <div class="profile-avatar" id="navbarAvatar" data-user-id="@navUserId" title="@displayName">@firstInitial</div>
                                        <div class="user-meta">
                                            <div class="user-welcome">@displayName</div>
                                            <div class="user-role">@userTypeDisplay</div>
                                        </div>
                                    </a>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                                        <li>
                                            <a class="dropdown-item" asp-controller="Home" asp-action="Profile">
                                                <i class="bi bi-person me-2"></i>Profile
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" asp-controller="Home" asp-action="AccountSettings">
                                                <i class="bi bi-person-gear me-2"></i>Account Settings
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" asp-controller="Home" asp-action="AdminMessages">
                                                <i class="bi bi-envelope-arrow-up me-2"></i>Contact Admin
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider" /></li>
                                        <li>
                                            <form method="post" asp-controller="Home" asp-action="Logout" class="m-0">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="dropdown-item text-danger">
                                                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                                                </button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                                @if (Context.Session.GetString("IsAdmin") == "true")
                                {
                                    <a href="@Url.Action("AdminDashboard", "Home")" class="btn-admin">Admin</a>
                                }
                            }
                            else
                            {
                                <!-- Not Logged In -->
                                @* Cart icon is NOT rendered for visitors *@
                                <a href="@Url.Action("Login", "Home")" class="btn-login-nav">
                                    <i class="bi bi-box-arrow-in-right"></i>
                                    <span>Login</span>
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Content Wrapper -->
    <div class="page-content">
        <div class="container">
            <main role="main" class="pb-3">
                @RenderBody()
            </main>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    
    @* Global message notification check and avatar loading - OPTIMIZED to reduce Firebase reads *@
    @if (Context.Session.GetString("UserId") != null)
    {
        <script>
            const globalUserId = '@Context.Session.GetString("UserId")';
            // Track initialization to prevent duplicate calls
            window._globalFeaturesInitialized = false;
            // Per-user cache keys for saved count
            const SAVED_COUNT_KEY = `savedProductsCount_${globalUserId}`;
            const SAVED_TS_KEY = `savedProductsCountTimestamp_${globalUserId}`;
        </script>
        <script type="module" src="~/js/firebase-client.js?v=@DateTime.Now.Ticks"></script>
        <script>
            // Presentation Mode toggle removed
            // Wait for Firebase to be ready and load avatar - OPTIMIZED with sessionStorage caching
            async function initGlobalFeatures() {
                if (window._globalFeaturesInitialized) return;
                window._globalFeaturesInitialized = true;
                
                const navbarAvatar = document.getElementById('navbarAvatar');
                
                // Avatar per-user cache (from previous change)
                const photoKey = `userPhotoUrl_${globalUserId}`;
                const tsKey = `userPhotoUrlTimestamp_${globalUserId}`;
                const cachedPhotoUrl = sessionStorage.getItem(photoKey);
                const cacheTimestamp = parseInt(sessionStorage.getItem(tsKey) || '0');
                const AVATAR_CACHE_TTL = 10 * 60 * 1000; // 10 minutes
                const avatarCacheValid = cachedPhotoUrl && (Date.now() - cacheTimestamp < AVATAR_CACHE_TTL);
                
                if (avatarCacheValid && navbarAvatar) {
                    applyAvatarImage(navbarAvatar, cachedPhotoUrl);
                    console.log('âœ… Using cached avatar (per-user, no Firebase read)');
                }
                
                // Wait for Firebase functions to be available
                let retries = 0;
                while (typeof window.firebaseGetUserProfile !== 'function' && retries < 30) {
                    await new Promise(r => setTimeout(r, 150));
                    retries++;
                }
                
                // Only fetch from Firebase if cache is invalid/expired
                if (!avatarCacheValid && navbarAvatar && globalUserId && typeof window.firebaseGetUserProfile === 'function') {
                    try {
                        const result = await window.firebaseGetUserProfile(globalUserId);
                        if (result.success && result.profile && result.profile.photo_url) {
                            const photoUrl = result.profile.photo_url;
                            applyAvatarImage(navbarAvatar, photoUrl);
                            // Cache per-user photo URL with timestamp
                            sessionStorage.setItem(photoKey, photoUrl);
                            sessionStorage.setItem(tsKey, Date.now().toString());
                            console.log('âœ… Avatar loaded from Firebase and cached per-user');
                        }
                    } catch (e) {
                        console.warn('Could not load navbar avatar:', e);
                    }
                }
                
                // Setup message notifications (uses real-time listener - efficient)
                if (typeof window.firebaseListenForNewMessages === 'function') {
                    const recomputeUnread = async () => {
                        try {
                            let unread = 0;
                            if (typeof window.firebaseGetUserConversations === 'function') {
                                const convRes = await window.firebaseGetUserConversations(globalUserId);
                                if (convRes?.success && Array.isArray(convRes.conversations)) {
                                    const convs = convRes.conversations;
                                    for (const conv of convs) {
                                        const readField = `lastReadBy_${globalUserId}`;
                                        const lastReadTime = conv[readField]?.seconds || 0;
                                        const lastMessageTime = conv.lastMessageTime?.seconds || 0;
                                        const isUnread = conv.lastMessageSenderId && conv.lastMessageSenderId !== globalUserId && lastMessageTime > lastReadTime;
                                        if (isUnread) unread++;
                                    }
                                }
                            } else if (typeof window.firebaseGetUnreadConversationsCount === 'function') {
                                const cRes = await window.firebaseGetUnreadConversationsCount(globalUserId);
                                if (cRes?.success) unread = cRes.count || 0;
                            }
                            const badge = document.querySelector('.messages-badge');
                            if (badge) {
                                if (unread > 0) {
                                    badge.textContent = unread > 99 ? '99+' : unread.toString();
                                    badge.style.display = 'inline-block';
                                } else {
                                    badge.textContent = '0';
                                    badge.style.display = 'none';
                                }
                            }
                        } catch (e) { console.warn('Unread recompute failed', e); }
                    };

                    setTimeout(recomputeUnread, 500);

                    window.firebaseListenForNewMessages(globalUserId, async function(notification) {
                        await recomputeUnread();
                    });
                }

                // Saved badge initial
                updateGlobalSavedBadge();
            }
            
            function applyAvatarImage(element, photoUrl) {
                if (!element || !photoUrl) return;
                element.style.backgroundImage = 'url("' + photoUrl + '")';
                element.style.backgroundSize = 'cover';
                element.style.backgroundPosition = 'center';
                element.innerHTML = '';
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initGlobalFeatures, { once: true });
            } else {
                initGlobalFeatures();
            }
        </script>
    }
    
    @await RenderSectionAsync("Scripts", required: false)

<!-- Saved Products Modal -->
<div class="modal fade" id="savedProductsModal" tabindex="-1" aria-labelledby="savedProductsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content saved-modal-content">
            <div class="modal-header saved-modal-header">
                <h5 class="modal-title fw-bold" id="savedProductsModalLabel">
                    <i class="bi bi-heart-fill text-danger me-2"></i>Saved Products
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body saved-modal-body">
                <div id="savedProductsLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading saved products...</p>
                </div>
                <div id="savedProductsEmpty" class="text-center py-5" style="display: none;">
                    <i class="bi bi-heart text-muted" style="font-size: 4rem;"></i>
                    <h5 class="mt-3 text-muted">No saved products yet</h5>
                    <p class="text-muted">Browse products and click the heart icon to save them here.</p>
                    <a href="/Home/Browse" class="btn btn-primary mt-2">Browse Products</a>
                </div>
                <div id="savedProductsGrid" class="saved-products-grid" style="display: none;">
                    <!-- Saved products will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Saved Products Modal Styles */
.saved-modal-content {
    border-radius: 20px !important;
    border: none !important;
    box-shadow: 0 25px 50px rgba(0,0,0,0.25) !important;
    overflow: hidden;
}

.saved-modal-header {
    padding: 1.25rem 1.5rem;
    background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
    border-bottom: 1px solid #fee2e2 !important;
}

.saved-modal-body {
    padding: 1.5rem;
    max-height: 65vh;
    overflow-y: auto;
    background: #fafafa;
}

/* Saved Products Grid */
.saved-products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 16px;
}

.saved-product-card {
    background: #ffffff;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
}

.saved-product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.15);
}

.saved-product-image {
    position: relative;
    width: 100%;
    aspect-ratio: 1;
    background: #f0f0f0;
    overflow: hidden;
}

.saved-product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.saved-product-card:hover .saved-product-image img {
    transform: scale(1.05);
}

.saved-product-remove {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: rgba(255,255,255,0.95);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 2;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.saved-product-remove:hover {
    background: #fee2e2;
    transform: scale(1.1);
}

.saved-product-remove i {
    color: #ef4444;
    font-size: 0.75rem;
}

.saved-product-info {
    padding: 12px;
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #fff;
}

.saved-product-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0 0 6px 0;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.saved-product-price {
    font-size: 1.1rem;
    font-weight: 700;
    color: #dc2626;
    margin: 0 0 8px 0;
}

.saved-product-seller {
    font-size: 0.7rem;
    color: #6b7280;
    margin: 0 0 4px 0;
    display: flex;
    align-items: center;
    gap: 4px;
}

.saved-product-category {
    font-size: 0.65rem;
    color: #0ea5e9;
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 4px;
}

.saved-product-condition {
    position: absolute;
    top: 8px;
    left: 8px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    font-size: 0.6rem;
    padding: 3px 8px;
    border-radius: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.saved-product-actions {
    margin-top: auto;
    padding-top: 8px;
}

.saved-product-actions .btn {
    font-size: 0.75rem;
    padding: 8px 12px;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.saved-product-actions .btn:hover {
    transform: translateY(-1px);
}

.action-icon.saved-icon i {
    color: #ef4444;
}

.action-icon.saved-icon:hover i {
    color: #dc2626;
}
</style>

<script>
// Saved Products Modal Functions
async function openSavedProductsModal() {
    const modal = new bootstrap.Modal(document.getElementById('savedProductsModal'));
    modal.show();
    
    const loadingEl = document.getElementById('savedProductsLoading');
    const emptyEl = document.getElementById('savedProductsEmpty');
    const gridEl = document.getElementById('savedProductsGrid');
    
    // Show loading
    loadingEl.style.display = 'block';
    emptyEl.style.display = 'none';
    gridEl.style.display = 'none';
    
    // Wait for Firebase to be ready
    let retries = 0;
    while (typeof window.firebaseGetSavedProducts !== 'function' && retries < 30) {
        await new Promise(r => setTimeout(r, 200));
        retries++;
    }
    
    if (typeof window.firebaseGetSavedProducts !== 'function') {
        loadingEl.innerHTML = '<p class="text-danger">Error loading saved products. Please refresh the page.</p>';
        return;
    }
    
    const userId = typeof globalUserId !== 'undefined' ? globalUserId : null;
    if (!userId) {
        loadingEl.style.display = 'none';
        emptyEl.innerHTML = `
            <i class="bi bi-person-x text-muted" style="font-size: 4rem;"></i>
            <h5 class="mt-3 text-muted">Please login</h5>
            <p class="text-muted">Login to view your saved products.</p>
            <a href="/Home/Login" class="btn btn-primary mt-2">Login</a>
        `;
        emptyEl.style.display = 'block';
        return;
    }
    
    try {
        const result = await window.firebaseGetSavedProducts(userId);
        loadingEl.style.display = 'none';
        
        const count = (result.success && Array.isArray(result.products)) ? result.products.length : 0;
        // Update per-user cache and badge from definitive modal data
        sessionStorage.setItem(`savedProductsCount_${userId}`, count.toString());
        sessionStorage.setItem(`savedProductsCountTimestamp_${userId}`, Date.now().toString());
        const badge = document.querySelector('.saved-icon .icon-badge'); if (badge){ badge.textContent = count > 99 ? '99+' : count.toString(); badge.style.display = count > 0 ? 'flex' : 'none'; }
        
        if (!result.success || !result.products || result.products.length === 0) {
            emptyEl.style.display = 'block';
            return;
        }
        
        // Render saved products
        gridEl.innerHTML = '';
        result.products.forEach(product => {
            const card = createSavedProductCard(product);
            gridEl.insertAdjacentHTML('beforeend', card);
        });
        
        gridEl.style.display = 'grid';
    } catch (err) {
        console.error('Error loading saved products:', err);
        loadingEl.innerHTML = '<p class="text-danger">Error loading saved products. Please try again.</p>';
    }
}

function createSavedProductCard(product) {
    // Handle both field naming conventions (snake_case from Firestore and camelCase)
    const imageUrl = product.imageUrl || product.image_url || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop';
    const title = product.title || 'Product';
    const priceText = window.formatCurrency(product.price || 0);
    const sellerName = product.sellerName || product.seller_name || 'Unknown Seller';
    const productId = product.productId || product.product_id || product.id;
    const category = product.category || '';
    const condition = product.condition || '';
    
    return `
        <div class="saved-product-card" id="saved-${productId}">
            <div class="saved-product-image">
                <img src="${imageUrl}" alt="${title}" onerror="this.src='https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&h=500&fit=crop'">
                <button class="saved-product-remove" onclick="removeSavedProduct('${productId}')" title="Remove from saved">
                    <i class="bi bi-x-lg"></i>
                </button>
                ${condition ? `<span class="saved-product-condition">${condition}</span>` : ''}
            </div>
            <div class="saved-product-info">
                <h6 class="saved-product-title" title="${title}">${title}</h6>
                <p class="saved-product-price">${priceText}</p>
                ${category ? `<p class="saved-product-category"><i class="bi ${window.categoryToIcon(category)} me-1"></i>${window.normalizeCategoryName ? window.normalizeCategoryName(category) : category}</p>` : ''}
                <p class="saved-product-seller"><i class="bi bi-person me-1"></i>${sellerName}</p>
                <div class="saved-product-actions">
                    <a href="/Home/Browse?productId=${productId}" class="btn btn-outline-primary btn-sm w-100">View Details</a>
                </div>
            </div>
        </div>
    `;
}

async function removeSavedProduct(productId) {
    const userId = typeof globalUserId !== 'undefined' ? globalUserId : null;
    if (!userId) return;
    
    try {
        const result = await window.firebaseUnsaveProduct(userId, productId);
        if (result.success) {
            // Remove card from UI with animation
            const card = document.getElementById(`saved-${productId}`);
            if (card) {
                card.style.transform = 'scale(0.8)';
                card.style.opacity = '0';
                setTimeout(() => card.remove(), 200);
            }
            
            const cachedCount = parseInt(sessionStorage.getItem(`savedProductsCount_${userId}`) || '0');
            const newCount = Math.max(0, cachedCount - 1);
            sessionStorage.setItem(`savedProductsCount_${userId}`, newCount.toString());
            sessionStorage.setItem(`savedProductsCountTimestamp_${userId}`, Date.now().toString());
            
            // Update badge immediately from local state (no Firebase read)
            const badge = document.querySelector('.saved-icon .icon-badge');
            if (badge) {
                badge.textContent = newCount > 99 ? '99+' : newCount.toString();
                badge.style.display = newCount > 0 ? 'flex' : 'none';
            }
            
            // Check if grid is now empty after animation
            setTimeout(() => {
                const gridEl = document.getElementById('savedProductsGrid');
                const emptyEl = document.getElementById('savedProductsEmpty');
                if (gridEl && gridEl.children.length === 0) {
                    gridEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                }
            }, 250);
            
            // Update browse page if on it
            if (typeof savedProductIds !== 'undefined') {
                savedProductIds.delete(productId);
                const browseBtn = document.querySelector(`#listing-${productId} .save-btn`);
                if (browseBtn) {
                    browseBtn.classList.remove('saved');
                    browseBtn.querySelector('i').className = 'bi bi-heart';
                }
            }
        }
    } catch (err) {
        console.error('Error removing saved product:', err);
    }
}

async function updateGlobalSavedBadge() {
    const userId = typeof globalUserId !== 'undefined' ? globalUserId : null;
    if (!userId) return;
    
    // Check sessionStorage cache first to reduce Firebase reads
    const cachedCount = sessionStorage.getItem(`savedProductsCount_${userId}`);
    const cacheTimestamp = parseInt(sessionStorage.getItem(`savedProductsCountTimestamp_${userId}`) || '0');
    const CACHE_TTL = 5 * 60 * 1000; // 5 minutes
    
    const badge = document.querySelector('.saved-icon .icon-badge');
    
    // Use cached value immediately if valid
    if (cachedCount !== null && (Date.now() - cacheTimestamp < CACHE_TTL)) {
        if (badge) {
            const count = parseInt(cachedCount) || 0;
            badge.textContent = count > 99 ? '99+' : count.toString();
            badge.style.display = count > 0 ? 'flex' : 'none';
        }
        console.log('ðŸ“¦ Using cached saved count:', cachedCount);
        return;
    }
    
    // Wait for Firebase to be ready
    if (typeof window.firebaseGetSavedProductIds !== 'function') return;
    
    try {
        const result = await window.firebaseGetSavedProductIds(userId);
        if (result.success) {
            const count = result.savedIds ? result.savedIds.length : 0;
            
            // Cache the count
            sessionStorage.setItem(`savedProductsCount_${userId}`, count.toString());
            sessionStorage.setItem(`savedProductsCountTimestamp_${userId}`, Date.now().toString());
            
            if (badge) {
                badge.textContent = count > 99 ? '99+' : count.toString();
                badge.style.display = count > 0 ? 'flex' : 'none';
            }
        }
    } catch (err) {
        console.error('Error updating saved badge:', err);
    }
}

// Initialize saved badge on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(updateGlobalSavedBadge, 1500);
});
</script>
</body>

</html>